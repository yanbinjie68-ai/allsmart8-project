<!DOCTYPE html>
<link rel="stylesheet" href="/static/css/admin.css">
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="智能设备管理后台">
    <title>智能设备管理后台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        /* 内联样式保留在HTML中 */
        .restricted-content {
            display: none;
        }

        .show {
            display: block !important;
        }

        #user-profile {
            display: none;
        }

        #login-modal.show {
            display: block;
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --text: #ecf0f1;
            --text-secondary: #bdc3c7;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --background: #1a1a2e;
            --card-bg: #16213e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            width: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1a2530;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .tab.active {
            background: var(--primary);
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .bg-blue {
            background: rgba(52, 152, 219, 0.2);
            color: var(--accent);
        }

        .bg-green {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .bg-orange {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }

        .bg-red {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .device-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .device-item:hover {
            transform: translateY(-5px);
        }

        .device-item-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .device-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .command-payload {
            font-family: monospace;
            font-size: 12px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: var(--success);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal .card {
            width: 500px;
            max-width: 90%;
            margin: 0;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        .permission-restricted {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .permission-restricted::after {
            content: "无访问权限";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            z-index: 1000;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .status-inactive {
            background: rgba(127, 140, 141, 0.2);
            color: var(--text-secondary);
        }

        .status-warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }

        .status-error {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .tag {
            display: inline-block;
            background: rgba(52, 152, 219, 0.2);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.8rem;
        }

        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .biometric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .biometric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .biometric-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .biometric-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .login-required {
            text-align: center;
            padding: 40px 20px;
        }

        .login-required i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--warning);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 20px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .device-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面头部 -->
        <header>
            <div class="logo">
                <i class="fas fa-cogs"></i>
                <h1>智能设备管理后台</h1>
            </div>
            <div class="search-box" style="max-width: 300px;">
                <input type="text" id="global-search" placeholder="全局搜索...">
                <button class="btn btn-primary" id="global-search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="current-time"></div>
            <!-- 用户信息区域 -->
            <div id="user-info" style="display: flex; align-items: center; margin-left: 20px;">
                <div id="login-info">
                    <button class="btn btn-primary" id="login-btn">登录</button>
                </div>
                <div id="user-profile" style="display: none; align-items: center;">
                    <span id="username" style="margin-right: 10px;"></span>
                    <button class="btn btn-danger" id="logout-btn">登出</button>
                </div>
            </div>
        </header>

        <!-- 标签页导航 -->
        <div class="tabs">
            <div class="tab active" data-target="dashboard">仪表盘</div>
            <div class="tab" data-target="api-config">API配置管理</div>
            <div class="tab" data-target="user-profiles">用户画像</div>
            <div class="tab" data-target="biometric">生物识别管理</div>
            <div class="tab" data-target="user-preferences">用户偏好设置</div>
            <div class="tab" data-target="user-management">用户管理</div>
            <div class="tab" data-target="system-management">系统管理</div>
            <div class="tab" data-target="device-management">设备管理</div>
            <div class="tab" data-target="device-registration">设备注册管理</div>
            <div class="tab" data-target="media-processing">媒体处理</div>
            <div class="tab" data-target="ai-services">AI服务</div>
            <div class="tab" data-target="workflow">工作流</div>
            <div class="tab" data-target="billing">计费统计</div>
            <div class="tab" data-target="system-settings">系统设置</div>
        </div>

        <!-- 仪表盘内容 -->
        <div class="content active" id="dashboard">
            <div class="card">
                <h2>欢迎使用智能设备管理后台</h2>
                <div id="welcome-content">
                    <p>请登录以访问所有功能。</p>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="total-users">0</h3>
                        <p>总用户数</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-green">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="total-devices">0</h3>
                        <p>设备总数</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-orange">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="ai-requests">0</h3>
                        <p>AI请求次数</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-red">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="chat-messages">0</h3>
                        <p>聊天消息数</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>用户行为分析</h2>
                <div class="chart-container">
                    <canvas id="behaviorChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>系统活动</h2>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>

    
        <!-- API配置管理 -->
        <div class="content" id="api-config">
            <div class="restricted-content" id="api-config-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary api-config-login-btn">立即登录</button>
                </div>
            </div>
            <!-- .env 配置预览 -->
            <div class="card">
                <h2>.env 配置预览</h2>
                <pre id="env-preview"></pre>
            </div>
            <div class="restricted-content" id="api-config-content">
                <div class="card">
                    <h2>API配置管理</h2>
                    <form id="api-config-form">
                        <input type="hidden" id="api-config-id">
                        <!-- 在表单中添加 name 和 endpoint 字段 -->
                        <div class="form-group">
                            <label for="api-name">API名称</label>
                            <input type="text" id="api-name" name="name" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="api-endpoint">API地址 (Endpoint)</label>
                            <input type="text" id="api-endpoint" name="endpoint" class="form-control" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="type">API类型</label>
                                <select id="api-type" name="type" required>
                                    <option value="media">媒体</option>
                                    <option value="chat">聊天</option>
                                    <option value="ai">AI</option>
                                    <option value="device">设备</option>
                                    <option value="network">网络</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="category">类别</label>
                                <select id="api-category" name="category">
                                    <option value="">无</option>
                                    <option value="music">音乐</option>
                                    <option value="video">视频</option>
                                    <option value="messaging">消息</option>
                                    <option value="nlp">自然语言处理</option>
                                    <option value="vision">计算机视觉</option>
                                    <option value="speech">语音识别</option>
                                    <option value="recommendation">推荐</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="provider">提供商</label>
                            <input type="text" id="api-provider" name="provider" class="form-control" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="api-method">HTTP方法</label>
                                <select id="api-method" name="method" class="form-control">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                    <option value="PATCH">PATCH</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="authType">认证类型</label>
                                <select id="api-authType" name="authType" class="form-control">
                                    <option value="none">无</option>
                                    <option value="apiKey">API Key</option>
                                    <option value="oauth">OAuth</option>
                                    <option value="bearer">Bearer Token</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="apiKey">API Key</label>
                                <input type="text" id="api-Key" name="apiKey" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="api-description">描述</label>
                            <textarea id="api-description" name="description" rows="3" class="form-control"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="api-max-requests">每小时最大请求数</label>
                                <input type="number" id="api-max-requests" name="max_requests" value="1000" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="api-priority">优先级</label>
                                <select id="api-priority" name="priority" class="form-control">
                                    <option value="1">低</option>
                                    <option value="2" selected>中</option>
                                    <option value="3">高</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="api-active" name="is_active" checked> 激活
                            </label>
                            <label style="margin-left: 20px;">
                                <input type="checkbox" id="api-public" name="is_public"> 公开
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="api-submit-btn">添加API配置</button>
                        <button type="button" class="btn btn-secondary" id="api-cancel-btn" style="display: none;">取消编辑</button>
                    </form>
                </div>
               
                <div class="restricted-content" id="api-config-content">
                    <div class="card">
                        <h2>API配置管理</h2>
                        <div class="search-box" style="margin-bottom: 20px;">
                            <input type="text" id="api-search" placeholder="搜索API配置...">
                            <button class="btn btn-primary" id="api-search-btn">搜索</button>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary" id="add-api-config-btn">
                                <i class="fas fa-plus"></i> 添加新API配置
                            </button>
                        </div>
                        
                        <div class="device-list" id="api-config-list">
                            <div class="empty-state">
                                <i class="fas fa-cogs"></i>
                                <p>暂无API配置</p>
                            </div>
                        </div>
                    </div>
                
                <!-- API监控面板 -->
                <div class="card">
                    <h2>API实时监控</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-api-requests">0</h3>
                                <p>总请求数</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="successful-requests">0</h3>
                                <p>成功请求</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-orange">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="failed-requests">0</h3>
                                <p>失败请求</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-red">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="avg-response-time">0 ms</h3>
                                <p>平均响应时间</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3>API调用趋势</h3>
                        <div style="height: 300px;">
                            <canvas id="api-usage-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 百万用户支持配置 -->
                <div class="card">
                    <h2>高并发配置</h2>
                    <div class="form-group">
                        <label for="concurrent-users">预计并发用户数</label>
                        <select id="concurrent-users">
                            <option value="10000">1万</option>
                            <option value="100000" selected>10万</option>
                            <option value="500000">50万</option>
                            <option value="1000000">100万</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="load-balancer">负载均衡配置</label>
                        <select id="load-balancer">
                            <option value="round-robin">轮询</option>
                            <option value="weighted-round-robin">加权轮询</option>
                            <option value="least-connections">最少连接</option>
                            <option value="ip-hash">IP哈希</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="caching-strategy">缓存策略</label>
                        <select id="caching-strategy">
                            <option value="redis">Redis</option>
                            <option value="memcached">Memcached</option>
                            <option value="in-memory">内存缓存</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable-compression" checked> 启用数据压缩
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable-connection-pooling" checked> 启用连接池
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" id="save-scaling-config-btn">
                            <span id="save-scaling-config-text">保存高并发配置</span>
                            <span id="save-scaling-config-loader" class="loading" style="display: none;"></span>
                        </button>
                    </div>
                </div>
            </div>

                <div class="card">
                    <h2>API配置列表</h2>
                    <div class="device-list" id="api-config-list">
                        <div class="empty-state">
                            <i class="fas fa-cogs"></i>
                            <p>暂无API配置</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户画像 -->
        <div class="content" id="user-profiles">
            <div class="restricted-content" id="user-profiles-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary user-profiles-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="user-profiles-content">
                <div class="card">
                    <h2>用户信息设置</h2>
                    <div class="form-group">
                        <label for="search-user-id">用户ID *</label>
                        <input type="text" id="search-user-id" required>
                    </div>
                    
                    <button id="search-user-btn" class="btn btn-primary">
                        <span id="search-user-text">搜索用户</span>
                        <span id="search-user-loader" class="loading" style="display: none;"></span>
                    </button>
                </div>
                
                <div class="card">
                    <h2>用户画像详情</h2>
                    <div id="user-profile-container">
                        <div class="empty-state">
                            <i class="fas fa-user"></i>
                            <p>请输入用户ID搜索用户画像</p>
                        </div>
                    </div>
                </div>
                
                <!-- 用户信息设置表单 -->
                <div class="card" id="user-info-card">
                    <h2>编辑用户信息</h2>
                    <input type="hidden" id="edit-user-id" name="userId">
                    <form id="user-info-form">
                        <div class="form-group">
                            <label for="edit-user-id-input">用户ID *</label>
                            <input type="text" id="edit-user-id-input" name="userId" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="user-name">姓名</label>
                                <input type="text" id="user-name" name="name">
                            </div>
                            
                            <div class="form-group">
                                <label for="user-age">年龄</label>
                                <input type="number" id="user-age" name="age">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="user-gender">性别</label>
                            <select id="user-gender" name="gender">
                                <option value="">请选择</option>
                                <option value="male">男</option>
                                <option value="female">女</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="user-city">城市</label>
                                <input type="text" id="user-city" name="city">
                            </div>
                            
                            <div class="form-group">
                                <label for="user-country">国家</label>
                                <input type="text" id="user-country" name="country">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="user-occupation">职业</label>
                            <input type="text" id="user-occupation" name="occupation">
                        </div>
                        
                        <div class="form-group">
                            <label for="user-tags">用户标签 (逗号分隔)</label>
                            <input type="text" id="user-tags" name="tags" placeholder="例如: tech-savvy, music-lover, frequent-shopper">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="save-user-btn">
                            <span id="save-user-text">保存用户信息</span>
                            <span id="save-user-loader" class="loading" style="display: none;"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div> 

        <!-- 生物识别管理 -->
        <div class="content" id="biometric">
            <div class="restricted-content" id="biometric-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary biometric-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="biometric-content">
                <div class="card">
                    <h2>生物识别管理</h2>
                    <div class="form-group">
                        <label for="biometric-user-id">用户ID</label>
                        <input type="text" id="biometric-user-id" placeholder="输入用户ID">
                    </div>
                    
                    <button id="load-biometric-btn" class="btn btn-primary">
                        <span id="load-biometric-text">加载生物识别信息</span>
                        <span id="load-biometric-loader" class="loading" style="display: none;"></span>
                    </button>
                </div>
                
                <div class="card">
                    <h2>生物识别信息</h2>
                    <div id="biometric-info-container">
                        <div class="empty-state">
                            <i class="fas fa-fingerprint"></i>
                            <p>请输入用户ID加载生物识别信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户偏好设置 -->        
        <div class="content" id="user-preferences">
            <div class="restricted-content" id="user-preferences-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary user-preferences-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="user-preferences-content">
                <div class="card">
                    <h2>用户偏好设置</h2>
                    <div class="form-group">
                        <label for="preference-user-id">用户ID</label>
                        <input type="text" id="preference-user-id" placeholder="输入用户ID">
                    </div>
                    
                    <div class="form-group">
                        <label for="preference-device-id">设备ID (可选)</label>
                        <input type="text" id="preference-device-id" placeholder="输入设备ID">
                    </div>
                    
                    <button id="load-preferences" class="btn btn-primary">
                        <span id="load-preferences-text">加载偏好设置</span>
                        <span id="load-preferences-loader" class="loading" style="display: none;"></span>
                    </button>
                    
                    <div id="preferences-container" style="margin-top: 20px;">
                        <div class="empty-state">
                            <i class="fas fa-sliders-h"></i>
                            <p>请输入用户ID加载偏好设置</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户管理 -->
        <div class="content" id="user-management">
            <div class="restricted-content" id="user-management-restricted">
            <div class="login-required">
                <i class="fas fa-lock"></i>
                <h3>访问受限</h3>
                <p>此功能需要登录才能访问</p>
                <button class="btn btn-primary user-management-login-btn">立即登录</button>
            </div>
            </div>
            <div class="restricted-content" id="user-management-content">
            <div class="card">
                <h2>用户管理</h2>
                <div class="search-box">
                    <input type="text" id="user-search" placeholder="搜索用户...">
                    <button class="btn btn-primary" id="user-search-btn">搜索</button>
                </div>
                
                <div class="form-group">
                    <label for="user-sort">排序方式</label>
                    <select id="user-sort">
                        <option value="name">按姓名</option>
                        <option value="registrationDate">按注册时间</option>
                        <option value="lastActive">按最后活跃时间</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-success" id="add-user-btn">
                        <i class="fas fa-plus"></i> 添加用户
                    </button>
                </div>
                
                <div class="user-list" id="user-list">
                    <!-- 用户列表将通过JavaScript动态加载 -->
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>暂无用户信息</p>
                    </div>
                </div>
                
                <div class="pagination" id="user-pagination">
                    <!-- 分页控件将通过JavaScript动态加载 -->
                </div>
            </div>

            <div class="card">
                <h2>批量操作</h2>
                <div class="form-group">
                    <button class="btn btn-warning" id="export-users-btn">导出用户数据</button>
                </div>
            </div>
            </div>
            </div>

            <!-- 系统管理 -->
            <div class="content" id="system-management">
            <div class="restricted-content" id="system-management-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary system-management-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="system-management-content">
                <div class="card">
                    <h2>系统状态</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpu-usage">0%</h3>
                                <p>CPU 使用率</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon bg-green">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="memory-usage">0%</h3>
                                <p>内存使用率</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon bg-orange">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="warning-devices-count">0</h3>
                                <p>警告设备</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon bg-red">
                                <i class="fas fa-power-off"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="offline-devices-count">0</h3>
                                <p>离线设备</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>设备管理</h2>
                    <div class="search-box">
                        <input type="text" id="device-search" placeholder="搜索设备...">
                        <button class="btn btn-primary" id="device-search-btn">搜索</button>
                    </div>
                    
                    <div class="device-list" id="device-list">
                        <div class="empty-state">
                            <i class="fas fa-tablet-alt"></i>
                            <p>暂无设备信息</p>
                        </div>
                    </div>
                    
                    <div class="pagination" id="device-pagination">
                        <!-- 分页控件将通过JavaScript动态加载 -->
                    </div>
                </div>
                
                <div class="card">
                    <h2>系统日志</h2>
                    <div class="form-group">
                        <label for="log-level">日志级别</label>
                        <select id="log-level">
                            <option value="all">全部</option>
                            <option value="info">信息</option>
                            <option value="warning">警告</option>
                            <option value="error">错误</option>
                        </select>
                    </div>
                    
                    <div class="device-list" id="log-list">
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>暂无日志信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备管理 -->
        <div class="content" id="device-management">
            <div class="restricted-content" id="device-management-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary device-management-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="device-management-content">
                <div class="card">
                    <h2>设备拓扑图</h2>
                    <div id="device-topology" style="height: 400px; background: var(--card-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <div class="empty-state">
                            <i class="fas fa-project-diagram"></i>
                            <p>设备拓扑图加载中</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>设备状态监控</h2>
                    <div class="search-box">
                        <input type="text" id="device-monitor-search" placeholder="搜索设备...">
                        <button class="btn btn-primary">搜索</button>
                    </div>
                    
                    <div class="device-list" id="device-monitor-list">
                        <div class="empty-state">
                            <i class="fas fa-tablet-alt"></i>
                            <p>暂无设备监控信息</p>
                        </div>
                    </div>
                </div>
                
                <!-- 新增网络连接设备表格 -->
                <div class="card">
                    <h2>网络连接设备</h2>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f1f5f9; text-align: left;">
                                    <th style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">设备ID</th>
                                    <th style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">设备名称</th>
                                    <th style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">IP地址</th>
                                    <th style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">MAC地址</th>
                                    <th style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">状态</th>
                                    <th style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">连接时间</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">DEV001</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">客厅智能灯</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">192.168.1.105</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">A1:B2:C3:D4:E5:F6</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;"><span style="color: #22c55e;">在线</span></td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">2023-06-15 08:32</td>
                                </tr>
                                <tr style="background-color: #f8fafc;">
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">DEV002</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">卧室空调</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">192.168.1.112</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">B2:C3:D4:E5:F6:A1</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;"><span style="color: #22c55e;">在线</span></td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">2023-06-15 08:45</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">DEV003</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">厨房音响</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">192.168.1.120</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">C3:D4:E5:F6:A1:B2</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;"><span style="color: #ef4444;">离线</span></td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">2023-06-14 17:22</td>
                                </tr>
                                <tr style="background-color: #f8fafc;">
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">DEV004</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">门锁系统</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">192.168.1.108</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">D4:E5:F6:A1:B2:C3</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;"><span style="color: #22c55e;">在线</span></td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">2023-06-15 07:15</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">DEV005</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">智能电视</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">192.168.1.130</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">E5:F6:A1:B2:C3:D4</td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;"><span style="color: #22c55e;">在线</span></td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid #e2e8f0;">2023-06-15 18:30</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 新增网络状态信息 -->
                <div class="card">
                    <h2>网络状态</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-blue">
                                <i class="fas fa-network-wired"></i>
                            </div>
                            <div class="stat-info">
                                <h3>192.168.1.1</h3>
                                <p>路由器IP</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-green">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div class="stat-info">
                                <h3>85 Mbps</h3>
                                <p>下载速度</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-orange">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <div class="stat-info">
                                <h3>42 Mbps</h3>
                                <p>上传速度</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-red">
                                <i class="fas fa-signal"></i>
                            </div>
                            <div class="stat-info">
                                <h3>-65 dBm</h3>
                                <p>WiFi信号</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备注册管理 -->
        <div class="content" id="device-registration">
            <div class="restricted-content" id="device-registration-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary device-registration-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="device-registration-content">
                <div class="card">
                    <h2>设备注册</h2>
                    <form id="device-register-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-id">设备ID *</label>
                                <input type="text" id="device-id" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="device-name">设备名称</label>
                                <input type="text" id="device-name">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="device-secret-key">设备密钥 *</label>
                            <input type="password" id="device-secret-key" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="device-model">设备型号</label>
                                <input type="text" id="device-model">
                            </div>
                            
                            <div class="form-group">
                                <label for="device-status">设备状态</label>
                                <select id="device-status">
                                    <option value="inactive">未激活</option>
                                    <option value="online">在线</option>
                                    <option value="offline">离线</option>
                                    <option value="warning">警告</option>
                                    <option value="error">错误</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="register-device-btn">
                            <span id="register-device-text">注册设备</span>
                            <span id="register-device-loader" class="loading" style="display: none;"></span>
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>设备列表</h2>
                        <button class="btn btn-primary" id="refresh-devices-btn">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                    </div>
                    <div class="device-list" id="device-list-container">
                        <div class="empty-state">
                            <i class="fas fa-tablet-alt"></i>
                            <p>暂无设备信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- 设备详情 -->
        <div class="content" id="device-details">
            <div class="restricted-content" id="device-details-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary device-details-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="device-details-content">
                <div class="card">
                    <h2>设备详情</h2>
                    <div class="form-group">
                        <label for="device-selector">选择设备</label>
                        <select id="device-selector">
                            <option value="">请选择设备</option>
                        </select>
                    </div>
                    
                    <div class="device-item">
                        <div class="device-item-header">
                            <div class="device-item-icon" style="background: rgba(52, 152, 219, 0.2); color: var(--accent);">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div>
                                <strong id="detail-device-name">N/A</strong>
                                <p style="font-size: 12px; margin: 0; color: var(--text-secondary);">
                                    ID: <span id="detail-device-id">N/A</span>
                                </p>
                            </div>
                        </div>
                        <div>
                            <p>型号: <span id="detail-device-model">N/A</span></p>
                            <p>状态: <span id="detail-device-status" class="status-badge status-inactive">N/A</span></p>
                            <p>注册时间: <span id="detail-device-created">N/A</span></p>
                            <p>更新时间: <span id="detail-device-updated">N/A</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>连接设置</h2>
                    <form id="device-connection-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="connection-ip">IP地址</label>
                                <input type="text" id="connection-ip" placeholder="例如: 192.168.1.100">
                            </div>
                            
                            <div class="form-group">
                                <label for="connection-port">端口</label>
                                <input type="number" id="connection-port" placeholder="例如: 8080">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="connection-mac">MAC地址</label>
                            <input type="text" id="connection-mac" placeholder="例如: 00:1A:2B:3C:4D:5E">
                        </div>
                        
                        <div class="form-group">
                            <label for="connection-protocol">通信协议</label>
                            <select id="connection-protocol">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="http">HTTP</option>
                                <option value="https">HTTPS</option>
                                <option value="mqtt">MQTT</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>连接状态: <span id="connection-status" class="status-badge status-inactive">N/A</span></label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="save-connection-btn">
                            <span id="save-connection-text">保存设置</span>
                            <span id="save-connection-loader" class="loading" style="display: none;"></span>
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>数据上报</h2>
                    <div id="data-reports-container">
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>暂无数据上报</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>控制指令</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="command-type">指令类型</label>
                            <select id="command-type">
                                <option value="reboot">重启设备</option>
                                <option value="update_config">更新配置</option>
                                <option value="collect_data">收集数据</option>
                                <option value="custom">自定义指令</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="command-priority">优先级</label>
                            <select id="command-priority">
                                <option value="1">低</option>
                                <option value="2">中</option>
                                <option value="3">高</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="command-payload">指令参数 (JSON格式)</label>
                        <textarea id="command-payload" rows="3" placeholder='{"param1": "value1", "param2": "value2"}'></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="send-command-btn">
                        <span id="send-command-text">发送指令</span>
                        <span id="send-command-loader" class="loading" style="display: none;"></span>
                    </button>
                    
                    <h3 style="margin-top: 20px;">指令队列</h3>
                    <div id="command-queue-container">
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <p>暂无待处理指令</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>  

        <!-- 媒体处理 -->
        <div class="content" id="media-processing">
            <div class="restricted-content" id="media-processing-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary media-processing-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="media-processing-content">
                <div class="card">
                    <h2>媒体处理流水线</h2>
                    <div class="form-group">
                        <label for="media-source">媒体源</label>
                        <select id="media-source">
                            <option value="">请选择媒体源</option>
                            <option value="camera1">摄像头1</option>
                            <option value="camera2">摄像头2</option>
                            <option value="microphone">麦克风</option>
                            <option value="file">文件上传</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="processing-pipeline">处理流程</label>
                        <select id="processing-pipeline" multiple size="5">
                            <option value="resize">尺寸调整</option>
                            <option value="compress">压缩</option>
                            <option value="filter">滤镜处理</option>
                            <option value="enhance">图像增强</option>
                            <option value="transcode">转码</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary">开始处理</button>
                </div>
                
                <div class="card">
                    <h2>视频预览</h2>
                    <div id="video-preview" style="height: 300px; background: var(--card-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <div class="empty-state">
                            <i class="fas fa-video"></i>
                            <p>视频预览区域</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>音频控制</h2>
                    <div class="form-group">
                        <label for="audio-volume">音量控制</label>
                        <input type="range" id="audio-volume" min="0" max="100" value="80">
                        <span id="volume-value">80%</span>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-success">播放</button>
                        <button class="btn btn-warning">暂停</button>
                        <button class="btn btn-danger">停止</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI服务 -->
        <div class="content" id="ai-services">
            <div class="restricted-content" id="ai-services-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary ai-services-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="ai-services-content">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon bg-blue">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="ai-services-count">0</h3>
                            <p>AI服务总数</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="ai-active-services">0</h3>
                            <p>活跃服务</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-orange">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="ai-warning-services">0</h3>
                            <p>警告服务</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-red">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="ai-error-services">0</h3>
                            <p>错误服务</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>AI API配置</h2>
                    <div class="api-list" id="ai-api-list">
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <p>暂无AI服务配置</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>AI服务使用情况</h2>
                    <div class="chart-container">
                        <canvas id="aiUsageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 工作流 -->
        <div class="content" id="workflow">
            <div class="restricted-content" id="workflow-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary workflow-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="workflow-content">
                <div class="card">
                    <h2>流程设计</h2>
                    <div id="workflow-designer" style="height: 400px; background: var(--card-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <div class="empty-state">
                            <i class="fas fa-draw-polygon"></i>
                            <p>工作流设计器</p>
                            <button class="btn btn-primary" style="margin-top: 15px;">新建流程</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>执行监控</h2>
                    <div class="search-box">
                        <input type="text" placeholder="搜索工作流...">
                        <button class="btn btn-primary">搜索</button>
                    </div>
                    
                    <div class="device-list" id="workflow-monitor-list">
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <p>暂无工作流执行信息</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>模板库</h2>
                    <div class="api-list" id="workflow-template-list">
                        <div class="empty-state">
                            <i class="fas fa-clone"></i>
                            <p>暂无工作流模板</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 计费统计 -->
        <div class="content" id="billing">
            <div class="restricted-content" id="billing-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary billing-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="billing-content">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon bg-blue">
                            <i class="fas fa-yen-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-cost">¥0.00</h3>
                            <p>总费用</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-green">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="api-cost">¥0.00</h3>
                            <p>API调用</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-orange">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="compute-cost">¥0.00</h3>
                            <p>计算资源</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon bg-red">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="storage-cost">¥0.00</h3>
                            <p>存储空间</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>用量分析</h2>
                    <div class="chart-container">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>账单管理</h2>
                    <div class="search-box">
                        <input type="text" placeholder="搜索账单...">
                        <button class="btn btn-primary">搜索</button>
                    </div>
                    
                    <div class="device-list" id="billing-list">
                        <div class="empty-state">
                            <i class="fas fa-file-invoice"></i>
                            <p>暂无账单信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统设置 -->
        <div class="content" id="system-settings">
            <div class="restricted-content" id="system-settings-restricted">
                <div class="login-required">
                    <i class="fas fa-lock"></i>
                    <h3>访问受限</h3>
                    <p>此功能需要登录才能访问</p>
                    <button class="btn btn-primary system-settings-login-btn">立即登录</button>
                </div>
            </div>
            <div class="restricted-content" id="system-settings-content">
                <div class="card">
                    <h2>管理员管理</h2>
                    <div class="search-box">
                        <input type="text" id="admin-search" placeholder="搜索管理员...">
                        <button class="btn btn-primary" id="admin-search-btn">搜索</button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-success" id="edit-admin-id">
                            <i class="fas fa-plus"></i> 添加管理员
                        </button>
                    </div>
                    
                    <div class="device-list" id="admin-list">
                        <div class="empty-state">
                            <i class="fas fa-user-shield"></i>
                            <p>暂无管理员信息</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>权限配置</h2>
                    <div class="form-group">
                        <label for="role-selector">角色选择</label>
                        <select id="role-selector">
                            <option value="">请选择角色</option>
                            <option value="admin">管理员</option>
                            <option value="operator">操作员</option>
                            <option value="viewer">查看者</option>
                        </select>
                    </div>
                    
                    <div class="preference-item">
                        <div>用户管理权限</div>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div>设备管理权限</div>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div>系统配置权限</div>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <button class="btn btn-primary">保存权限配置</button>
                </div>
                
                <div class="card">
                    <h2>系统维护</h2>
                    <div class="form-group">
                        <button class="btn btn-warning">备份数据库</button>
                        <button class="btn btn-danger">重启服务</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenance-mode">维护模式</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="maintenance-mode">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 登录模态框 -->
        <div id="login-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>用户登录</h2>
                    <span class="close" id="close-login-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-username">用户名</label>
                            <input type="text" id="login-username" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">密码</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remember-me"> 记住我
                            </label>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="login-submit-btn">
                                <span id="login-submit-text">登录</span>
                                <span id="login-submit-loader" class="loading" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- 编辑用户模态框 -->
        <div id="edit-admin-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>编辑用户</h2>
                <form id="edit-admin-form">
                    <input type="hidden" id="edit-admin-id">
                    <div class="form-group">
                        <label for="edit-adminname">用户名</label>
                        <input type="text" id="edit-adminname" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-email">邮箱</label>
                        <input type="email" id="edit-email" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-role">角色</label>
                        <select id="edit-role">
                            <option value="admin1">普通用户</option>
                            <option value="admin2">管理员</option>
                            <option value="admin">高级管理员</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-is-active">状态</label>
                        <input type="checkbox" id="edit-is-active">
                        <span>激活</span>
                    </div>
                    <div class="form-group">
                        <button type="button" id="save-user-btn" class="btn btn-primary">保存</button>
                        <button type="button" id="cancel-user-btn" class="btn btn-secondary">取消</button>
                    </div>
                </form>
            </div>
        
            
            <div class="device-list" id="user-list">
                <!-- 用户列表将通过JavaScript动态加载 -->
            </div>
            
            <div class="card">
                <h2>管理员列表</h2>
                <div class="search-box">
                    <input type="text" id="admin-search" placeholder="搜索管理员...">
                    <button class="btn btn-primary" id="admin-search-btn">搜索</button>
                </div>
                
                <div class="device-list" id="admin-list">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>暂无管理员信息</p>
                    </div>
                </div>
            </div>
        <div id="notification" class="notification"></div>
        </div>

    <script>
         // 示例：改进 API 请求
        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    timeout: 10000 // 设置超时
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const users = await response.json();
                renderUsers(users);
            } catch (error) {
                console.error('加载用户失败:', error);
                utils.showNotification('加载用户失败，请稍后再试', 'error');
            }
        } 
          // 用户管理模块
        const userManagement = {
            currentPage: 1,
            pageSize: 10,
            totalUsers: 0,
            
            // 初始化用户管理模块
            init: async function() {
                // 检查用户是否已登录
                if (!authManager.isAuthenticated()) {
                    console.log('用户未登录，无法初始化用户管理模块');
                    return;
                }
                
                // 检查用户是否为管理员
                const isAdmin = await authManager.isAdmin();
                if (!isAdmin) {
                    console.log('用户不是管理员，无法访问用户管理功能');
                    return;
                }
                
                // 确保DOM元素存在再绑定事件
                const userSearchBtn = document.getElementById('user-search-btn');
                const userSearchInput = document.getElementById('user-search');
                const addUserBtn = document.getElementById('add-user-btn');
                const addAdminBtn = document.getElementById('add-admin-btn');
                const userSortSelect = document.getElementById('user-sort');
                
                if (userSearchBtn) {
                    userSearchBtn.addEventListener('click', () => {
                        const search = document.getElementById('user-search').value;
                        this.loadUsers(search, 1);
                    });
                }
                
                if (userSearchInput) {
                    userSearchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const search = document.getElementById('user-search').value;
                            this.loadUsers(search, 1);
                        }
                    });
                }
                
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', () => {
                        this.showAddUserModal('user');
                    });
                }
                
                if (addAdminBtn) {
                    addAdminBtn.addEventListener('click', () => {
                        this.showAddUserModal('admin');
                    });
                }
                
                if (userSortSelect) {
                    userSortSelect.addEventListener('change', () => {
                        const search = document.getElementById('user-search').value;
                        this.loadUsers(search, this.currentPage);
                    });
                }
                
                // 初始加载用户列表
                this.loadUsers();
            },
            
            // 加载用户列表
            loadUsers: async function(search = '', page = 1) {
                const userListContainer = document.getElementById('user-list');
                const paginationContainer = document.getElementById('user-pagination');
                
                // 检查必要的DOM元素是否存在
                if (!userListContainer) {
                    console.error('User list container not found');
                    return;
                }
                
                try {
                    // 显示加载状态
                    userListContainer.innerHTML = `
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>正在加载用户列表...</p>
                        </div>
                    `;
                    
                    // 构建查询参数
                    const params = new URLSearchParams({
                        skip: (page - 1) * this.pageSize,
                        limit: this.pageSize
                    });
                    
                    if (search) {
                        params.append('search', search);
                    }
                    
                    // 获取认证token
                    const token = authManager.getToken();
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 发送请求获取用户列表
                    const response = await fetch(`/users?${params.toString()}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('未授权访问，请重新登录');
                        }
                        if (response.status === 403) {
                            throw new Error('权限不足，需要管理员权限');
                        }
                        throw new Error('获取用户列表失败');
                    }
                    
                    const result = await response.json();
                    const users = result.users || [];
                    this.totalUsers = result.total || 0;
                    this.currentPage = page;
                    
                    // 显示用户列表
                    this.displayUsers(users);
                    
                    // 更新分页控件
                    this.updatePagination(page);
                } catch (error) {
                    console.error('Load users error:', error);
                    userListContainer.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>加载用户列表失败: ${error.message}</p>
                            <button class="btn btn-primary" onclick="userManagement.loadUsers()">重试</button>
                        </div>
                    `;
                }
            },
            
            // 显示用户列表
            displayUsers: function(users) {
                const userListContainer = document.getElementById('user-list');
                
                if (!userListContainer) return;
                
                if (!users || users.length === 0) {
                    userListContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>暂无用户信息</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                users.forEach(user => {
                    html += `
                        <div class="user-item" data-user-id="${user.id}">
                            <div class="user-info">
                                <h4>${this.escapeHtml(user.username)}</h4>
                                <p>${this.escapeHtml(user.email)}</p>
                                <span class="user-role ${user.role}">${user.role === 'admin' ? '管理员' : '普通用户'}</span>
                                <span class="user-status ${user.is_active ? 'active' : 'inactive'}">
                                    ${user.is_active ? '激活' : '未激活'}
                                </span>
                                <span class="user-created-at">注册时间: ${new Date(user.created_at).toLocaleString()}</span>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-sm btn-primary edit-user-btn" data-user-id="${user.id}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" ${user.username === 'admin' ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                userListContainer.innerHTML = html;
                
                // 绑定编辑和删除事件
                this.bindUserActions();
            },
            
            // 绑定用户操作事件
            bindUserActions: function() {
                // 绑定编辑按钮点击事件
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('.edit-user-btn').getAttribute('data-user-id');
                        this.editUser(userId);
                    });
                });
                
                // 绑定删除按钮点击事件
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('.delete-user-btn').getAttribute('data-user-id');
                        this.deleteUser(userId);
                    });
                });
            },
            
            // 显示添加用户模态框
            showAddUserModal: function(role = 'user') {
                // 检查模态框是否已存在
                if (document.getElementById('add-user-modal')) {
                    document.getElementById('add-user-modal').remove();
                }
                
                // 创建模态框HTML
                const modalHtml = `
                    <div id="add-user-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>添加${role === 'admin' ? '管理员' : '用户'}</h2>
                            <form id="add-user-form">
                                <div class="form-group">
                                    <label for="add-username">用户名</label>
                                    <input type="text" id="add-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-email">邮箱</label>
                                    <input type="email" id="add-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-password">密码</label>
                                    <input type="password" id="add-password" required>
                                </div>
                                <input type="hidden" id="add-role" value="${role}">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="add-is-active" checked>
                                        激活账户
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="button" id="create-user-btn" class="btn btn-primary">创建${role === 'admin' ? '管理员' : '用户'}</button>
                                    <button type="button" id="cancel-add-user-btn" class="btn btn-secondary">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('add-user-modal');
                const closeBtn = modal.querySelector('.close');
                
                // 显示模态框
                modal.style.display = 'block';
                
                // 绑定事件
                closeBtn.onclick = () => {
                    modal.remove();
                };
                
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.remove();
                    }
                };
                
                document.getElementById('cancel-add-user-btn').onclick = () => {
                    modal.remove();
                };
                
                document.getElementById('create-user-btn').onclick = () => {
                    this.createUser();
                };
            },
            
            // 创建新用户
            createUser: async function() {
                try {
                    const username = document.getElementById('add-username').value;
                    const email = document.getElementById('add-email').value;
                    const password = document.getElementById('add-password').value;
                    const role = document.getElementById('add-role').value;
                    const is_active = document.getElementById('add-is-active').checked;
                    
                    // 获取认证token
                    const token = authManager.getToken();
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 发送创建请求
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            password: password,
                            role: role,
                            is_active: is_active
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || result.message || '创建用户失败');
                    }
                    
                    // 关闭模态框
                    if (document.getElementById('add-user-modal')) {
                        document.getElementById('add-user-modal').remove();
                    }
                    
                    // 重新加载用户列表
                    this.loadUsers();
                    
                    utils.showNotification(`${role === 'admin' ? '管理员' : '用户'}创建成功`, 'success');
                } catch (error) {
                    utils.showNotification('创建失败: ' + error.message, 'error');
                }
            },
            
            // 编辑用户
            editUser: async function(userId) {
                try {
                    // 获取认证token
                    const token = authManager.getToken();
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 获取用户详细信息
                    const response = await fetch(`/users/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('获取用户信息失败');
                    }
                    
                    const user = await response.json();
                    
                    // 显示编辑模态框
                    this.showEditUserModal(user);
                } catch (error) {
                    utils.showNotification('获取用户信息失败: ' + error.message, 'error');
                }
            },
            
            // 显示编辑用户模态框
            showEditUserModal: function(user) {
                // 检查模态框是否已存在
                if (document.getElementById('edit-user-modal')) {
                    document.getElementById('edit-user-modal').remove();
                }
                
                // 创建模态框HTML
                const modalHtml = `
                    <div id="edit-user-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>编辑用户</h2>
                            <form id="edit-user-form">
                                <input type="hidden" id="edit-user-id" value="${user.id}">
                                <div class="form-group">
                                    <label for="edit-username">用户名</label>
                                    <input type="text" id="edit-username" value="${this.escapeHtml(user.username)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-email">邮箱</label>
                                    <input type="email" id="edit-email" value="${this.escapeHtml(user.email)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-role">角色</label>
                                    <select id="edit-role">
                                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>普通用户</option>
                                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>管理员</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="edit-is-active" ${user.is_active ? 'checked' : ''}>
                                        激活账户
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="button" id="save-user-btn" class="btn btn-primary">保存</button>
                                    <button type="button" id="cancel-user-btn" class="btn btn-secondary">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('edit-user-modal');
                const closeBtn = modal.querySelector('.close');
                
                // 显示模态框
                modal.style.display = 'block';
                
                // 绑定事件
                closeBtn.onclick = () => {
                    modal.remove();
                };
                
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.remove();
                    }
                };
                
                document.getElementById('cancel-user-btn').onclick = () => {
                    modal.remove();
                };
                
                document.getElementById('save-user-btn').onclick = () => {
                    this.saveUser();
                };
            },
            
            // 保存用户信息
            saveUser: async function() {
                try {
                    const userId = document.getElementById('edit-user-id').value;
                    const username = document.getElementById('edit-username').value;
                    const email = document.getElementById('edit-email').value;
                    const role = document.getElementById('edit-role').value;
                    const is_active = document.getElementById('edit-is-active').checked;
                    
                    // 获取认证token
                    const token = authManager.getToken();
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 发送更新请求
                    const response = await fetch(`/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            role: role,
                            is_active: is_active
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('更新用户信息失败');
                    }
                    
                    // 关闭模态框
                    if (document.getElementById('edit-user-modal')) {
                        document.getElementById('edit-user-modal').remove();
                    }
                    
                    // 重新加载用户列表
                    this.loadUsers();
                    
                    utils.showNotification('用户信息更新成功', 'success');
                } catch (error) {
                    utils.showNotification('保存失败: ' + error.message, 'error');
                }
            },
            
            // 删除用户
            deleteUser: function(userId) {
                if (confirm('确定要删除这个用户吗？此操作不可恢复！')) {
                    this.performDeleteUser(userId);
                }
            },
            
            // 执行删除用户操作
            performDeleteUser: async function(userId) {
                try {
                    // 获取认证token
                    const token = authManager.getToken();
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    const response = await fetch(`/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('删除用户失败');
                    }
                    
                    // 重新加载用户列表
                    this.loadUsers();
                    
                    utils.showNotification('用户删除成功', 'success');
                } catch (error) {
                    utils.showNotification('删除失败: ' + error.message, 'error');
                }
            },
            
            // 更新分页控件
            updatePagination: function(currentPage) {
                const paginationContainer = document.getElementById('user-pagination');
                if (!paginationContainer) return;
                
                const totalPages = Math.ceil(this.totalUsers / this.pageSize);
                
                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                let html = '<div class="pagination-controls">';
                
                // 上一页按钮
                if (currentPage > 1) {
                    html += `<button class="btn btn-sm" onclick="userManagement.loadUsers('', ${currentPage - 1})">上一页</button>`;
                }
                
                // 页码
                for (let i = 1; i <= totalPages; i++) {
                    if (i === currentPage) {
                        html += `<span class="page-number active">${i}</span>`;
                    } else {
                        html += `<button class="btn btn-sm" onclick="userManagement.loadUsers('', ${i})">${i}</button>`;
                    }
                }
                
                // 下一页按钮
                if (currentPage < totalPages) {
                    html += `<button class="btn btn-sm" onclick="userManagement.loadUsers('', ${currentPage + 1})">下一页</button>`;
                }
                
                html += '</div>';
                
                paginationContainer.innerHTML = html;
            },
            
            // 转义HTML特殊字符，防止XSS攻击
            escapeHtml: function(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
        };
        // 工具函数
        const utils = {
            // 显示通知
            showNotification: function(message, type = 'success') {
                const notification = document.getElementById('notification');
                if (!notification) {
                    // 如果通知元素不存在，创建一个
                    const notif = document.createElement('div');
                    notif.id = 'notification';
                    notif.className = 'notification';
                    document.body.appendChild(notif);
                }
                
                const notifElement = document.getElementById('notification');
                notifElement.textContent = message;
                notifElement.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notifElement.classList.remove('show');
                }, 3000);
            },
            
            // 显示加载状态
            setButtonLoading: function(button, textElement, loaderElement, isLoading) {
                if (isLoading) {
                    textElement.style.display = 'none';
                    loaderElement.style.display = 'inline-block';
                    button.disabled = true;
                } else {
                    textElement.style.display = 'inline-block';
                    loaderElement.style.display = 'none';
                    button.disabled = false;
                }
            },
            
            // 格式化日期
            formatDate: function(date) {
                return new Date(date).toLocaleString('zh-CN');
            },
            
            // 防抖函数
            debounce: function(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // 确认对话框
            confirmAction: function(message) {
                return new Promise((resolve) => {
                    const result = confirm(message);
                    resolve(result);
                });
            }
        };
        
        // 仪表盘模块
        const dashboardManager = {
            // 加载仪表盘统计数据
            loadDashboardStats: async function() {
                try {
                    // 模拟数据
                    document.getElementById('total-users').textContent = '1,248';
                    document.getElementById('total-devices').textContent = '3,572';
                    document.getElementById('ai-requests').textContent = '18,246';
                    document.getElementById('chat-messages').textContent = '45,892';
                    
                    // 初始化图表
                    this.initCharts();
                } catch (error) {
                    console.error('加载仪表盘数据失败:', error);
                }
            },
            
            // 初始化图表
            initCharts: function() {
                const behaviorCtx = document.getElementById('behaviorChart').getContext('2d');
                new Chart(behaviorCtx, {
                    type: 'bar',
                    data: {
                        labels: ['媒体', 'AI', '聊天', '购物', '导航'],
                        datasets: [{
                            label: '使用时长 (小时)',
                            data: [12.5, 3.2, 1.8, 0.9, 2.1],
                            backgroundColor: [
                                'rgba(52, 152, 219, 0.2)',
                                'rgba(46, 204, 113, 0.2)',
                                'rgba(241, 196, 15, 0.2)',
                                'rgba(230, 126, 34, 0.2)',
                                'rgba(155, 89, 182, 0.2)'
                            ],
                            borderColor: [
                                'rgba(52, 152, 219, 1)',
                                'rgba(46, 204, 113, 1)',
                                'rgba(241, 196, 15, 1)',
                                'rgba(230, 126, 34, 1)',
                                'rgba(155, 89, 182, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
                
                const activityCtx = document.getElementById('activityChart').getContext('2d');
                new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                        datasets: [{
                            label: '在线用户数',
                            data: [120, 85, 320, 450, 380, 290],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            },
            
            // 更新当前时间
            updateCurrentTime: function() {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
            }
        };
        
        // 在用户偏好设置模块后添加API配置管理模块
        // API配置管理模块
        const apiConfigManager = {
            isEditing: false,
            currentEditId: null,
            
            // 初始化API配置管理功能
            init: function() {
                // 绑定表单提交事件
                document.getElementById('api-config-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveApiConfig();
                });
                
                // 绑定取消编辑按钮事件
                document.getElementById('api-cancel-btn').addEventListener('click', () => {
                    this.cancelEdit();
                });
                
                // 绑定搜索按钮事件
                document.getElementById('api-search-btn').addEventListener('click', () => {
                    this.loadApiConfigs();
                });
                
                // 绑定搜索输入框回车事件
                document.getElementById('api-search').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        this.loadApiConfigs();
                    }
                });
                
                // 首次加载API配置列表
                this.loadApiConfigs();
                this.loadEnvPreview();
            },
            
            // 保存API配置
            saveApiConfig: async function() {
                try {
                    const name = document.getElementById('api-name').value;
                    const endpoint = document.getElementById('api-endpoint').value;
                    const method = document.getElementById('api-method').value;
                    const description = document.getElementById('api-description').value;
                    const isActive = document.getElementById('api-active').checked;
                    const isPublic = document.getElementById('api-public').checked;
                    const authType = document.getElementById('api-authType').value;
                    const provider = document.getElementById('api-provider').value;
                    const category = document.getElementById('api-category').value;
                    const maxRequests = parseInt(document.getElementById('api-max-requests').value) || 1000;
                    const priority = parseInt(document.getElementById('api-priority').value) || 2;
                    const apiKey = document.getElementById('api-Key').value;
                    const type = document.getElementById('api-type').value;

                    // 验证输入
                    if (!name || !endpoint) {
                        utils.showNotification('名称和端点不能为空', 'error');
                        return;
                    }

                    const apiConfigData = {
                        name,
                        endpoint,
                        method,
                        description,
                        is_active: isActive,
                        is_public: isPublic,
                        auth_type: authType,
                        provider,
                        category,
                        max_requests: maxRequests,
                        priority,
                        api_key: apiKey,
                        type
                    };

                    let url = '/api/api-configs';
                    let methodType = 'POST';
                    
                    // 如果是编辑模式，更新URL和方法
                    if (this.isEditing && this.currentEditId) {
                        url = `/api/api-configs/${this.currentEditId}`;
                        methodType = 'PUT';
                        // 编辑时如果没有更改API Key，则不发送该字段
                        if (!apiKey) {
                            delete apiConfigData.api_key;
                        }
                    }

                    // 发送请求到后端
                    const response = await fetch(url, {
                        method: methodType,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(apiConfigData)
                    });

                    if (response.ok) {
                        utils.showNotification('API配置保存成功', 'success');
                        this.resetForm();
                        this.loadApiConfigs();
                        this.loadEnvPreview(); // 刷新 .env 预览
                    } else {
                        const errorData = await response.json();
                        utils.showNotification(`保存API配置失败: ${errorData.detail || '未知错误'}`, 'error');
                    }
                } catch (error) {
                    utils.showNotification(`保存API配置时发生错误: ${error.message}`, 'error');
                }
            },
            
            // 编辑API配置
            editApiConfig: function(config) {
                // 填充表单字段
                document.getElementById('api-config-id').value = config.id || '';
                document.getElementById('api-name').value = config.name || '';
                document.getElementById('api-endpoint').value = config.endpoint || '';
                document.getElementById('api-type').value = config.type || 'media';
                document.getElementById('api-category').value = config.category || '';
                document.getElementById('api-provider').value = config.provider || '';
                document.getElementById('api-authType').value = config.auth_type || 'none';
                document.getElementById('api-Key').value = ''; // 不显示已加密的密钥
                document.getElementById('api-description').value = config.description || '';
                document.getElementById('api-max-requests').value = config.max_requests || 1000;
                document.getElementById('api-priority').value = config.priority || 2;
                document.getElementById('api-method').value = config.method || 'GET';
                document.getElementById('api-active').checked = config.is_active || false;
                document.getElementById('api-public').checked = config.is_public || false;

                // 更新按钮文本
                document.getElementById('api-submit-btn').textContent = '更新API配置';
                document.getElementById('api-cancel-btn').style.display = 'inline-block';

                this.isEditing = true;
                this.currentEditId = config.id;

                // 滚动到表单位置
                document.querySelector('#api-config-form').scrollIntoView({ behavior: 'smooth' });
            },
            
            // 取消编辑
            cancelEdit: function() {
                this.resetForm();
            },
            
            // 重置表单
            resetForm: function() {
                document.getElementById('api-config-form').reset();
                document.getElementById('api-config-id').value = '';
                
                // 更新按钮文本
                document.getElementById('api-submit-btn').textContent = '添加API配置';
                document.getElementById('api-cancel-btn').style.display = 'none';
                
                this.isEditing = false;
                this.currentEditId = null;
            },
            
            // 删除API配置
            deleteApiConfig: async function(configId, configName) {
                if (confirm(`确定要删除API配置 "${configName}" 吗？此操作不可撤销。`)) {
                    try {
                        // 发送删除请求到后端
                        const response = await fetch(`/api/api-configs/${configId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            utils.showNotification('API配置删除成功');
                            this.loadApiConfigs();
                            this.loadEnvPreview(); // 刷新 .env 预览
                        } else {
                            utils.showNotification('删除API配置失败', 'error');
                        }
                    } catch (error) {
                        utils.showNotification('删除API配置时发生错误: ' + error.message, 'error');
                    }
                }
            },
            
            // 加载API配置
            loadApiConfigs: async function() {
                try {
                    const searchTerm = document.getElementById('api-search').value;
                    let url = '/api/api-configs?skip=0&limit=100';
                    if (searchTerm) {
                        url += `&search=${encodeURIComponent(searchTerm)}`;
                    }
                    
                    const response = await fetch(url);
                    if (response.ok) {
                        const apiConfigs = await response.json();
                        this.displayApiConfigs(apiConfigs);
                    } else {
                        throw new Error('获取API配置失败');
                    }
                } catch (error) {
                    utils.showNotification('加载API配置失败: ' + error.message, 'error');
                }
            },
            
            // 显示API配置
            displayApiConfigs: function(configs) {
                const container = document.getElementById('api-config-list');
                
                if (!configs || configs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-cogs"></i>
                            <p>暂无API配置</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                configs.forEach(config => {
                    html += `
                        <div class="device-item">
                            <div class="device-item-header">
                                <div class="device-item-icon" style="background: rgba(52, 152, 219, 0.2); color: var(--accent);">
                                    <i class="fas fa-code"></i>
                                </div>
                                <div>
                                    <strong>${config.name}</strong>
                                    <p style="font-size: 12px; margin: 0; color: var(--text-secondary);">
                                        ${config.endpoint} [${config.method}]
                                    </p>
                                </div>
                            </div>
                            <div style="margin: 10px 0;">
                                <p style="font-size: 13px; margin: 0; color: var(--text-secondary);">
                                    ${config.description || '无描述'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <span class="status-badge ${config.is_active ? 'status-active' : 'status-inactive'}">
                                    ${config.is_active ? '激活' : '未激活'}
                                </span>
                                <span class="status-badge ${config.is_public ? 'status-active' : 'status-inactive'}">
                                    ${config.is_public ? '公开' : '私有'}
                                </span>
                                <span class="status-badge">
                                    ${config.method}
                                </span>
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
                                <div>创建: ${config.created_at ? new Date(config.created_at).toLocaleDateString('zh-CN') : 'N/A'}</div>
                                <div>更新: ${config.updated_at ? new Date(config.updated_at).toLocaleDateString('zh-CN') : 'N/A'}</div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-sm btn-primary" onclick='apiConfigManager.editApiConfig(${JSON.stringify(config)})'>
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-danger" onclick='apiConfigManager.deleteApiConfig(${config.id}, "${config.name}")'>
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            // 加载.env预览
            loadEnvPreview: async function() {
                try {
                    const response = await fetch('/api/env-preview');
                    const envData = await response.json();
                    document.getElementById('env-preview').textContent = JSON.stringify(envData, null, 2);
                } catch (error) {
                    utils.showNotification('加载 .env 预览失败: ' + error.message, 'error');
                }
            }
        };
        

        // 用户管理模块
        const userManager = {
            currentPage: 1,
            pageSize: 10,
            totalUsers: 0,
            
            // 初始化用户管理模块
            init: function() {
                // 确保DOM元素存在再绑定事件
                const userSearchBtn = document.getElementById('user-search-btn');
                const userSearchInput = document.getElementById('user-search');
                const addUserBtn = document.getElementById('add-user-btn');
                const userSortSelect = document.getElementById('user-sort');
                
                if (userSearchBtn) {
                    userSearchBtn.addEventListener('click', () => {
                        const search = document.getElementById('user-search').value;
                        this.loadUsers(search, 1);
                    });
                }
                
                if (userSearchInput) {
                    userSearchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const search = document.getElementById('user-search').value;
                            this.loadUsers(search, 1);
                        }
                    });
                }
                
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', () => {
                        this.showAddUserModal();
                    });
                }
                
                if (userSortSelect) {
                    userSortSelect.addEventListener('change', () => {
                        const search = document.getElementById('user-search').value;
                        this.loadUsers(search, this.currentPage);
                    });
                }
                
                // 初始加载用户列表
                this.loadUsers();
            },
            
            // 加载用户列表
            loadUsers: async function(search = '', page = 1) {
                const userListContainer = document.getElementById('user-list');
                const paginationContainer = document.getElementById('user-pagination');
                
                // 检查必要的DOM元素是否存在
                if (!userListContainer) {
                    console.error('User list container not found');
                    return;
                }
                
                try {
                    // 显示加载状态
                    userListContainer.innerHTML = `
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>正在加载用户列表...</p>
                        </div>
                    `;
                    
                    // 构建查询参数
                    const params = new URLSearchParams({
                        skip: (page - 1) * this.pageSize,
                        limit: this.pageSize
                    });
                    
                    if (search) {
                        params.append('search', search);
                    }
                    
                    // 获取认证token
                    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 发送请求获取用户列表
                    const response = await fetch(`/api/users?${params.toString()}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('未授权访问，请重新登录');
                        }
                        throw new Error('获取用户列表失败');
                    }
                    
                    const result = await response.json();
                    const users = result.users || [];
                    this.totalUsers = result.total || 0;
                    this.currentPage = page;
                    
                    // 显示用户列表
                    this.displayUsers(users);
                    
                    // 更新分页控件
                    this.updatePagination(page);
                } catch (error) {
                    console.error('Load users error:', error);
                    userListContainer.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>加载用户列表失败: ${error.message}</p>
                            <button class="btn btn-primary" onclick="userManager.loadUsers()">重试</button>
                        </div>
                    `;
                }
            },
            
            // 显示用户列表
            displayUsers: function(users) {
                const userListContainer = document.getElementById('user-list');
                
                if (!userListContainer) return;
                
                if (!users || users.length === 0) {
                    userListContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>暂无用户信息</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                users.forEach(user => {
                    html += `
                        <div class="user-item" data-user-id="${user.id}">
                            <div class="user-info">
                                <h4>${this.escapeHtml(user.username)}</h4>
                                <p>${this.escapeHtml(user.email)}</p>
                                <span class="user-role ${user.role}">${user.role}</span>
                                <span class="user-status ${user.is_active ? 'active' : 'inactive'}">
                                    ${user.is_active ? '激活' : '未激活'}
                                </span>
                                <span class="user-created-at">注册时间: ${new Date(user.created_at).toLocaleString()}</span>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-sm btn-primary edit-user-btn" data-user-id="${user.id}">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" ${user.username === 'admin' ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                userListContainer.innerHTML = html;
                
                // 绑定编辑和删除事件
                this.bindUserActions();
            },
            
            // 绑定用户操作事件
            bindUserActions: function() {
                // 绑定编辑按钮点击事件
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('.edit-user-btn').getAttribute('data-user-id');
                        this.editUser(userId);
                    });
                });
                
                // 绑定删除按钮点击事件
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('.delete-user-btn').getAttribute('data-user-id');
                        this.deleteUser(userId);
                    });
                });
            },
            
            // 显示添加用户模态框
            showAddUserModal: function() {
                // 检查模态框是否已存在
                if (document.getElementById('add-user-modal')) {
                    document.getElementById('add-user-modal').remove();
                }
                
                // 创建模态框HTML
                const modalHtml = `
                    <div id="add-user-modal" class="modal hidden">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>添加用户</h2>
                            <form id="add-user-form">
                                <div class="form-group">
                                    <label for="add-username">用户名</label>
                                    <input type="text" id="add-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-email">邮箱</label>
                                    <input type="email" id="add-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-password">密码</label>
                                    <input type="password" id="add-password" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-role">角色</label>
                                    <select id="add-role">
                                        <option value="user">普通用户</option>
                                        <option value="admin">管理员</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="add-is-active" checked>
                                        激活账户
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="button" id="create-user-btn" class="btn btn-primary">创建用户</button>
                                    <button type="button" id="cancel-add-user-btn" class="btn btn-secondary">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('add-user-modal');
                const closeBtn = modal.querySelector('.close');
                
                // 显示模态框
                modal.style.display = 'block';
                
                // 绑定事件
                closeBtn.onclick = () => {
                    modal.remove();
                };
                
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.remove();
                    }
                };
                
                document.getElementById('cancel-add-user-btn').onclick = () => {
                    modal.remove();
                };
                
                document.getElementById('create-user-btn').onclick = () => {
                    this.createUser();
                };
            },
            
            // 创建新用户
            createUser: async function() {
                try {
                    const username = document.getElementById('add-username').value;
                    const email = document.getElementById('add-email').value;
                    const password = document.getElementById('add-password').value;
                    const role = document.getElementById('add-role').value;
                    const is_active = document.getElementById('add-is-active').checked;
                    
                    // 获取认证token
                    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 发送创建请求到与user.html相同的API端点
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            password: password,
                            role: role,
                            is_active: is_active
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || result.message || '创建用户失败');
                    }
                    
                    // 关闭模态框
                    if (document.getElementById('add-user-modal')) {
                        document.getElementById('add-user-modal').remove();
                    }
                    
                    // 重新加载用户列表
                    this.loadUsers();
                    
                    utils.showNotification('用户创建成功', 'success');
                } catch (error) {
                    utils.showNotification('创建失败: ' + error.message, 'error');
                }
            },
            
            // 编辑用户
            editUser: async function(userId) {
                try {
                    // 获取认证token
                    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 获取用户详细信息
                    const response = await fetch(`/users/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('获取用户信息失败');
                    }
                    
                    const user = await response.json();
                    
                    // 显示编辑模态框
                    this.showEditUserModal(user);
                } catch (error) {
                    utils.showNotification('获取用户信息失败: ' + error.message, 'error');
                }
            },
            
            // 显示编辑用户模态框
            showEditUserModal: function(user) {
                // 检查模态框是否已存在
                if (document.getElementById('edit-user-modal')) {
                    document.getElementById('edit-user-modal').remove();
                }
                
                // 创建模态框HTML
                const modalHtml = `
                    <div id="edit-user-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>编辑用户</h2>
                            <form id="edit-user-form">
                                <input type="hidden" id="edit-user-id" value="${user.id}">
                                <div class="form-group">
                                    <label for="edit-username">用户名</label>
                                    <input type="text" id="edit-username" value="${this.escapeHtml(user.username)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-email">邮箱</label>
                                    <input type="email" id="edit-email" value="${this.escapeHtml(user.email)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-role">角色</label>
                                    <select id="edit-role">
                                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>普通用户</option>
                                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>管理员</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="edit-is-active" ${user.is_active ? 'checked' : ''}>
                                        激活账户
                                    </label>
                                </div>
                                <div class="form-group">
                                    <button type="button" id="save-user-btn" class="btn btn-primary">保存</button>
                                    <button type="button" id="cancel-user-btn" class="btn btn-secondary">取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('edit-user-modal');
                const closeBtn = modal.querySelector('.close');
                
                // 显示模态框
                modal.style.display = 'block';
                
                // 绑定事件
                closeBtn.onclick = () => {
                    modal.remove();
                };
                
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.remove();
                    }
                };
                
                document.getElementById('cancel-user-btn').onclick = () => {
                    modal.remove();
                };
                
                document.getElementById('save-user-btn').onclick = () => {
                    this.saveUser();
                };
            },
            
            // 保存用户信息
            saveUser: async function() {
                try {
                    const userId = document.getElementById('edit-user-id').value;
                    const username = document.getElementById('edit-username').value;
                    const email = document.getElementById('edit-email').value;
                    const role = document.getElementById('edit-role').value;
                    const is_active = document.getElementById('edit-is-active').checked;
                    
                    // 获取认证token
                    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    // 发送更新请求
                    const response = await fetch(`/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            role: role,
                            is_active: is_active
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('更新用户信息失败');
                    }
                    
                    // 关闭模态框
                    if (document.getElementById('edit-user-modal')) {
                        document.getElementById('edit-user-modal').remove();
                    }
                    
                    // 重新加载用户列表
                    this.loadUsers();
                    
                    utils.showNotification('用户信息更新成功', 'success');
                } catch (error) {
                    utils.showNotification('保存失败: ' + error.message, 'error');
                }
            },
            
            // 删除用户
            deleteUser: function(userId) {
                if (confirm('确定要删除这个用户吗？此操作不可恢复！')) {
                    this.performDeleteUser(userId);
                }
            },
            
            // 执行删除用户操作
            performDeleteUser: async function(userId) {
                try {
                    // 获取认证token
                    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('未登录');
                    }
                    
                    const response = await fetch(`/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('删除用户失败');
                    }
                    
                    // 重新加载用户列表
                    this.loadUsers();
                    
                    utils.showNotification('用户删除成功', 'success');
                } catch (error) {
                    utils.showNotification('删除失败: ' + error.message, 'error');
                }
            },
            
            // 更新分页控件
            updatePagination: function(currentPage) {
                const paginationContainer = document.getElementById('user-pagination');
                if (!paginationContainer) return;
                
                const totalPages = Math.ceil(this.totalUsers / this.pageSize);
                
                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                let html = '<div class="pagination-controls">';
                
                // 上一页按钮
                if (currentPage > 1) {
                    html += `<button class="btn btn-sm" onclick="userManager.loadUsers('', ${currentPage - 1})">上一页</button>`;
                }
                
                // 页码
                for (let i = 1; i <= totalPages; i++) {
                    if (i === currentPage) {
                        html += `<span class="page-number active">${i}</span>`;
                    } else {
                        html += `<button class="btn btn-sm" onclick="userManager.loadUsers('', ${i})">${i}</button>`;
                    }
                }
                
                // 下一页按钮
                if (currentPage < totalPages) {
                    html += `<button class="btn btn-sm" onclick="userManager.loadUsers('', ${currentPage + 1})">下一页</button>`;
                }
                
                html += '</div>';
                
                paginationContainer.innerHTML = html;
            },
            
            // 转义HTML特殊字符，防止XSS攻击
            escapeHtml: function(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
        };
        
        // 生物识别管理模块
        const biometricManager = {
            currentUserId: null,
            
            // 加载生物识别信息
            loadBiometricInfo: async function() {
                const userId = document.getElementById('biometric-user-id').value;
                if (!userId) {
                    utils.showNotification('请输入有效的用户ID', 'warning');
                    return;
                }
                
                this.currentUserId = userId;
                
                const loadBtn = document.getElementById('load-biometric-btn');
                const loadText = document.getElementById('load-biometric-text');
                const loadLoader = document.getElementById('load-biometric-loader');
                
                utils.setButtonLoading(loadBtn, loadText, loadLoader, true);
                
                try {
                    const response = await fetch(`/api/biometric/${userId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        if (!result.data || Object.keys(result.data).length === 0) {
                            utils.showNotification('该用户尚未注册任何生物识别信息', 'warning');
                            // Show empty state with registration instructions
                            this.displayBiometricInfo(null);
                        } else {
                            this.displayBiometricInfo(result.data);
                            utils.showNotification('生物识别信息加载成功');
                        }
                    } else {
                        // More specific error handling
                        switch(result.error) {
                            case 'USER_NOT_FOUND':
                                utils.showNotification('用户不存在', 'error');
                                break;
                            case 'BIOMETRIC_NOT_REGISTERED':
                                utils.showNotification('用户未注册生物识别信息', 'warning');
                                this.displayBiometricInfo(null);
                                break;
                            default:
                                utils.showNotification('加载失败: ' + result.error, 'error');
                        }
                    }
                } catch (error) {
                    utils.showNotification('网络错误，请检查连接后重试: ' + error.message, 'error');
                } finally {
                    utils.setButtonLoading(loadBtn, loadText, loadLoader, false);
                }
            },
            
            // 显示生物识别信息
            displayBiometricInfo: function(biometricInfo) {
                const container = document.getElementById('biometric-info-container');
                
                if (!biometricInfo) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-fingerprint"></i>
                            <p>未找到生物识别信息</p>
                            <p style="font-size: 14px; margin-top: 10px;">请确保用户ID正确且已注册生物识别信息</p>
                            <button class="btn btn-primary" style="margin-top: 15px;" onclick="biometricManager.showRegistrationGuide()">
                                查看注册指南
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // 检查整体状态
                const isReadyForIdentification = this.checkBiometricStatus(biometricInfo);
                
                // 添加状态指示器
                let statusHtml = '';
                if (isReadyForIdentification) {
                    statusHtml = `
                        <div class="preference-item" style="background: rgba(46, 204, 113, 0.2); border-left: 4px solid #2ecc71; margin-bottom: 20px;">
                            <div>
                                <strong style="color: #2ecc71;">生物识别已就绪</strong>
                                <p style="font-size: 14px; margin: 5px 0 0 0;">系统可以进行生物识别验证</p>
                            </div>
                            <div class="status-badge status-active">就绪</div>
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div class="preference-item" style="background: rgba(231, 76, 60, 0.2); border-left: 4px solid #e74c3c; margin-bottom: 20px;">
                            <div>
                                <strong style="color: #e74c3c;">生物识别未就绪</strong>
                                <p style="font-size: 14px; margin: 5px 0 0 0;">请确保至少一种生物识别方法已正确注册且置信度足够</p>
                            </div>
                            <div class="status-badge status-inactive">未就绪</div>
                        </div>
                    `;
                }
                
                // 验证每种生物识别类型
                const hasVoicePrint = biometricInfo.voicePrint && biometricInfo.voicePrint.enrolledAt;
                const hasFaceData = biometricInfo.faceData && biometricInfo.faceData.enrolledAt;
                const hasFingerprint = biometricInfo.fingerprint && biometricInfo.fingerprint.enrolledAt;
                
                const voicePrint = biometricInfo.voicePrint || {};
                const faceData = biometricInfo.faceData || {};
                const fingerprint = biometricInfo.fingerprint || {};
                const otherBiometrics = biometricInfo.otherBiometrics || [];
                
                let html = statusHtml + `
                    <div class="biometric-grid">
                        <div class="biometric-card">
                            <div class="biometric-icon" style="color: #3498db;">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <h3>声纹识别</h3>
                            <p>
                                <span class="biometric-status ${voicePrint.isActive ? 'status-active' : 'status-inactive'}">
                                    ${voicePrint.isActive ? '已激活' : '未激活'}
                                </span>
                            </p>
                            <p>置信度: ${(voicePrint.confidence * 100 || 0).toFixed(1)}%</p>
                            <p>注册时间: ${voicePrint.enrolledAt ? utils.formatDate(voicePrint.enrolledAt) : '未注册'}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-sm btn-warning" onclick="biometricManager.toggleBiometricStatus('voicePrint', ${voicePrint.isActive})">
                                    ${voicePrint.isActive ? '禁用' : '启用'}
                                </button>
                            </div>
                        </div>
                        
                        <div class="biometric-card">
                            <div class="biometric-icon" style="color: #2ecc71;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h3>人脸识别</h3>
                            <p>
                                <span class="biometric-status ${faceData.isActive ? 'status-active' : 'status-inactive'}">
                                    ${faceData.isActive ? '已激活' : '未激活'}
                                </span>
                            </p>
                            <p>置信度: ${(faceData.confidence * 100 || 0).toFixed(1)}%</p>
                            <p>注册时间: ${faceData.enrolledAt ? utils.formatDate(faceData.enrolledAt) : '未注册'}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-sm btn-warning" onclick="biometricManager.toggleBiometricStatus('faceData', ${faceData.isActive})">
                                    ${faceData.isActive ? '禁用' : '启用'}
                                </button>
                            </div>
                        </div>
                        
                        <div class="biometric-card">
                            <div class="biometric-icon" style="color: #f39c12;">
                                <i class="fas fa-fingerprint"></i>
                            </div>
                            <h3>指纹识别</h3>
                            <p>
                                <span class="biometric-status ${fingerprint.isActive ? 'status-active' : 'status-inactive'}">
                                    ${fingerprint.isActive ? '已激活' : '未激活'}
                                </span>
                            </p>
                            <p>置信度: ${(fingerprint.confidence * 100 || 0).toFixed(1)}%</p>
                            <p>注册时间: ${fingerprint.enrolledAt ? utils.formatDate(fingerprint.enrolledAt) : '未注册'}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-sm btn-warning" onclick="biometricManager.toggleBiometricStatus('fingerprint', ${fingerprint.isActive})">
                                    ${fingerprint.isActive ? '禁用' : '启用'}
                                </button>
                            </div>
                        </div>
                `;
                
                // 添加其他生物识别方式
                otherBiometrics.forEach((bio, index) => {
                    html += `
                        <div class="biometric-card">
                            <div class="biometric-icon" style="color: #9b59b6;">
                                <i class="fas fa-${this.getBiometricIcon(bio.type)}"></i>
                            </div>
                            <h3>${this.getBiometricTypeName(bio.type)}</h3>
                            <p>
                                <span class="biometric-status ${bio.isActive ? 'status-active' : 'status-inactive'}">
                                    ${bio.isActive ? '已激活' : '未激活'}
                                </span>
                            </p>
                            <p>置信度: ${(bio.confidence * 100 || 0).toFixed(1)}%</p>
                            <p>注册时间: ${bio.enrolledAt ? utils.formatDate(bio.enrolledAt) : '未注册'}</p>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-sm btn-warning" onclick="biometricManager.toggleOtherBiometricStatus('${bio.type}', ${bio.isActive})">
                                    ${bio.isActive ? '禁用' : '启用'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // 添加操作按钮
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-danger" onclick="biometricManager.resetBiometricData()" style="margin-right: 10px;">
                            <i class="fas fa-trash-alt"></i> 重置所有生物识别数据
                        </button>
                        <button class="btn btn-primary" onclick="biometricManager.refreshBiometricData()">
                            <i class="fas fa-sync-alt"></i> 刷新数据
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
            },
            
            // 检查生物识别状态
            checkBiometricStatus: function(biometricInfo) {
                if (!biometricInfo) return false;
                
                const voicePrint = biometricInfo.voicePrint || {};
                const faceData = biometricInfo.faceData || {};
                const fingerprint = biometricInfo.fingerprint || {};
                
                // 检查至少有一种生物识别方法正确注册
                const hasValidVoice = voicePrint.isActive && voicePrint.confidence > 0.7 && voicePrint.enrolledAt;
                const hasValidFace = faceData.isActive && faceData.confidence > 0.7 && faceData.enrolledAt;
                const hasValidFingerprint = fingerprint.isActive && fingerprint.confidence > 0.7 && fingerprint.enrolledAt;
                
                return hasValidVoice || hasValidFace || hasValidFingerprint;
            },
            
            // 显示注册指南
            showRegistrationGuide: function() {
                alert("生物识别注册指南:\n1. 声纹识别: 在安静环境下朗读指定文本\n2. 人脸识别: 面对摄像头，保持光线充足\n3. 指纹识别: 清洁手指后按压指纹传感器");
            },
            
            // 获取生物识别图标
            getBiometricIcon: function(type) {
                const iconMap = {
                    'iris': 'eye',
                    'palm': 'hand-paper',
                    'handGeometry': 'hand-point-up',
                    'signature': 'signature',
                    'dna': 'dna'
                };
                return iconMap[type] || 'user-shield';
            },
            
            // 获取生物识别类型名称
            getBiometricTypeName: function(type) {
                const nameMap = {
                    'iris': '虹膜识别',
                    'palm': '掌纹识别',
                    'handGeometry': '手形识别',
                    'signature': '签名识别',
                    'dna': 'DNA识别'
                };
                return nameMap[type] || type;
            },
            
            // 切换生物识别状态
            toggleBiometricStatus: async function(biometricType, currentStatus) {
                if (!this.currentUserId) {
                    utils.showNotification('请先加载用户信息', 'warning');
                    return;
                }
                
                try {
                    const settings = {};
                    settings[biometricType] = { isActive: !currentStatus };
                    
                    const response = await fetch(`/api/biometric/${this.currentUserId}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        utils.showNotification(`${this.getBiometricTypeName(biometricType)}状态更新成功`);
                        // 重新加载数据
                        this.loadBiometricInfo();
                    } else {
                        utils.showNotification(`更新失败: ${result.error}`, 'error');
                    }
                } catch (error) {
                    utils.showNotification(`更新失败: ${error.message}`, 'error');
                }
            },
            
            // 切换其他生物识别状态
            toggleOtherBiometricStatus: async function(biometricType, currentStatus) {
                if (!this.currentUserId) {
                    utils.showNotification('请先加载用户信息', 'warning');
                    return;
                }
                
                try {
                    // 对于其他生物识别方式，我们需要不同的处理方式
                    const response = await fetch(`/api/biometric/${this.currentUserId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        const biometricInfo = result.data;
                        const otherBiometrics = biometricInfo.otherBiometrics || [];
                        
                        // 找到对应的生物识别数据并更新状态
                        const updatedOtherBiometrics = otherBiometrics.map(bio => {
                            if (bio.type === biometricType) {
                                return { ...bio, isActive: !currentStatus };
                            }
                            return bio;
                        });
                        
                        // 发送更新请求
                        const updateResponse = await fetch(`/api/biometric/${this.currentUserId}/settings`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ otherBiometrics: updatedOtherBiometrics })
                        });
                        
                        const updateResult = await updateResponse.json();
                        
                        if (updateResult.success) {
                            utils.showNotification(`${this.getBiometricTypeName(biometricType)}状态更新成功`);
                            // 重新加载数据
                            this.loadBiometricInfo();
                        } else {
                            utils.showNotification(`更新失败: ${updateResult.error}`, 'error');
                        }
                    } else {
                        utils.showNotification('获取用户生物识别信息失败', 'error');
                    }
                } catch (error) {
                    utils.showNotification(`更新失败: ${error.message}`, 'error');
                }
            },
            
            // 重置生物识别数据
            resetBiometricData: async function() {
                if (!this.currentUserId) {
                    utils.showNotification('请先加载用户信息', 'warning');
                    return;
                }
                
                if (!confirm('确定要重置该用户的所有生物识别数据吗？此操作不可恢复！')) {
                    return;
                }
                
                try {
                    const settings = {
                        voicePrint: { template: null, enrolledAt: null, confidence: 0, isActive: false },
                        faceData: { template: null, enrolledAt: null, confidence: 0, isActive: false },
                        fingerprint: { template: null, enrolledAt: null, confidence: 0, isActive: false },
                        otherBiometrics: []
                    };
                    
                    const response = await fetch(`/api/biometric/${this.currentUserId}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        utils.showNotification('生物识别数据重置成功');
                        // 重新加载数据
                        this.loadBiometricInfo();
                    } else {
                        utils.showNotification(`重置失败: ${result.error}`, 'error');
                    }
                } catch (error) {
                    utils.showNotification(`重置失败: ${error.message}`, 'error');
                }
            },
            
            // 刷新生物识别数据
            refreshBiometricData: function() {
                if (this.currentUserId) {
                    document.getElementById('biometric-user-id').value = this.currentUserId;
                    this.loadBiometricInfo();
                }
            }
        };
        
        // 用户偏好设置模块
        const preferenceManager = {
            // 加载用户偏好设置
            loadUserPreferences: async function() {
                const userId = document.getElementById('preference-user-id').value;
                const deviceId = document.getElementById('preference-device-id').value;
                
                if (!userId) {
                    utils.showNotification('请输入用户ID', 'warning');
                    return;
                }
                
                const loadBtn = document.getElementById('load-preferences');
                const loadText = document.getElementById('load-preferences-text');
                const loadLoader = document.getElementById('load-preferences-loader');
                
                utils.setButtonLoading(loadBtn, loadText, loadLoader, true);
                
                try {
                    // 模拟API调用
                    const response = await fetch(`/api/preferences?userId=${userId}${deviceId ? `&deviceId=${deviceId}` : ''}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.displayUserPreferences(result.data);
                        utils.showNotification('偏好设置加载成功');
                    } else {
                        utils.showNotification('加载失败: ' + result.error, 'error');
                    }
                } catch (error) {
                    utils.showNotification('网络错误，请检查连接后重试: ' + error.message, 'error');
                } finally {
                    utils.setButtonLoading(loadBtn, loadText, loadLoader, false);
                }
            },
            
            // 显示用户偏好设置
            displayUserPreferences: function(preferences) {
                const container = document.getElementById('preferences-container');
                
                if (!preferences || !preferences.preferences || preferences.preferences.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-sliders-h"></i>
                            <p>该用户没有设置偏好</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="preference-list">';
                
                preferences.preferences.forEach(pref => {
                    html += `
                        <div class="preference-item">
                            <div>
                                <strong>${pref.apiType}</strong>
                                <p style="font-size: 14px; margin: 5px 0 0 0;">类别: ${pref.category}</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" ${pref.enabled ? 'checked' : ''} 
                                       onchange="preferenceManager.togglePreference('${pref.apiType}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // 添加保存按钮
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="preferenceManager.savePreferences()">
                            <i class="fas fa-save"></i> 保存偏好设置
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
            },
            
            // 切换偏好设置
            togglePreference: function(apiType, enabled) {
                console.log(`切换偏好设置: ${apiType} -> ${enabled}`);
                // 在实际应用中，这里会更新内部状态，等待用户点击保存按钮
            },
            
            // 保存偏好设置
            savePreferences: async function() {
                const userId = document.getElementById('preference-user-id').value;
                const deviceId = document.getElementById('preference-device-id').value;
                
                if (!userId) {
                    utils.showNotification('请先加载用户偏好设置', 'warning');
                    return;
                }
                
                // 收集当前设置
                const preferenceItems = document.querySelectorAll('.preference-item');
                const preferences = [];
                
                preferenceItems.forEach(item => {
                    const apiType = item.querySelector('strong').textContent;
                    const enabled = item.querySelector('input[type="checkbox"]').checked;
                    preferences.push({ apiType, enabled });
                });
                
                try {
                    const response = await fetch('/api/preferences', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId, deviceId, preferences })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        utils.showNotification('偏好设置保存成功');
                    } else {
                        utils.showNotification('保存失败: ' + result.error, 'error');
                    }
                } catch (error) {
                    utils.showNotification('保存失败: ' + error.message, 'error');
                }
            }
        };

        // 系统设置管理模块
        const systemSettingsManager = {
            // API端点
            apiEndpoints: {
                admins: '/api/admins',
                roles: '/api/roles',
                permissions: '/api/permissions'
            },
            
            // 初始化系统设置功能
            init: function() {
                // 检查用户权限
                if (!permissionManager.hasRole('admin')) {
                    console.warn('用户没有足够的权限访问系统设置');
                    return;
                }
                
                // 绑定管理员管理事件
                this.bindAdminManagementEvents();
                
                // 绑定权限配置事件
                this.bindPermissionConfigEvents();
                
                // 绑定系统维护事件
                this.bindSystemMaintenanceEvents();
                
                // 加载管理员列表
                this.loadAdminList();
            },
            
            // 绑定管理员管理事件
            bindAdminManagementEvents: function() {
                const addAdminBtn = document.getElementById('add-admin-btn');
                if (addAdminBtn) {
                    // 只有超级管理员才能添加管理员
                    if (permissionManager.hasRole('superadmin')) {
                        addAdminBtn.addEventListener('click', () => {
                            this.showAddAdminModal();
                        });
                    } else {
                        // 隐藏添加管理员按钮
                        addAdminBtn.style.display = 'none';
                    }
                }
                
                const adminSearchBtn = document.getElementById('admin-search-btn');
                if (adminSearchBtn) {
                    adminSearchBtn.addEventListener('click', () => {
                        this.searchAdmins();
                    });
                }
            },
            
            // 绑定权限配置事件
            bindPermissionConfigEvents: function() {
                const roleSelector = document.getElementById('role-selector');
                if (roleSelector) {
                    roleSelector.addEventListener('change', () => {
                        this.loadRolePermissions(roleSelector.value);
                    });
                }
                
                const savePermissionsBtn = document.querySelector('#system-settings-content .btn-primary');
                if (savePermissionsBtn) {
                    savePermissionsBtn.addEventListener('click', () => {
                        this.saveRolePermissions();
                    });
                }
            },
            
            // 绑定系统维护事件
            bindSystemMaintenanceEvents: function() {
                const backupBtn = document.querySelector('.btn-warning');
                const restartBtn = document.querySelector('.btn-danger');
                const maintenanceMode = document.getElementById('maintenance-mode');
                
                // 只有超级管理员才能执行系统维护操作
                if (permissionManager.hasRole('superadmin')) {
                    if (backupBtn) {
                        backupBtn.addEventListener('click', () => {
                            this.backupDatabase();
                        });
                    }
                    
                    if (restartBtn) {
                        restartBtn.addEventListener('click', () => {
                            this.restartService();
                        });
                    }
                    
                    if (maintenanceMode) {
                        maintenanceMode.addEventListener('change', () => {
                            this.toggleMaintenanceMode(maintenanceMode.checked);
                        });
                    }
                } else {
                    // 隐藏或禁用维护按钮
                    if (backupBtn) backupBtn.style.display = 'none';
                    if (restartBtn) restartBtn.style.display = 'none';
                    if (maintenanceMode) maintenanceMode.disabled = true;
                }
            },
            
            // 加载管理员列表
            loadAdminList: async function() {
                // 只有管理员及以上角色才能查看管理员列表
                if (!permissionManager.hasRole('admin')) {
                    return;
                }
                
                const adminListContainer = document.getElementById('admin-list');
                if (!adminListContainer) return;
                
                try {
                    // 显示加载状态
                    adminListContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>加载中...</p>
                        </div>
                    `;
                    
                    // 从服务器获取管理员列表
                    const response = await fetch(this.apiEndpoints.admins, {
                        headers: {
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('无法加载管理员列表');
                    }
                    
                    const result = await response.json();
                    const admins = result.data || [];
                    
                    let html = '';
                    admins.forEach(admin => {
                        html += `
                            <div class="device-item">
                                <div class="device-info">
                                    <h3>${admin.username}</h3>
                                    <p>角色: ${admin.role}</p>
                                    <p>最后登录: ${admin.lastLogin || 'N/A'}</p>
                                </div>
                                <div class="device-actions">
                                    ${
                                        permissionManager.hasRole('superadmin') && admin.username !== 'admin' 
                                        ? `<button class="btn btn-sm btn-warning" onclick="systemSettingsManager.editAdmin(${admin.id})">编辑</button>
                                           <button class="btn btn-sm btn-danger" onclick="systemSettingsManager.deleteAdmin(${admin.id})">删除</button>`
                                        : admin.username === 'admin' 
                                        ? '<span class="status-badge status-active">系统账户</span>'
                                        : '<span class="status-badge status-inactive">只读</span>'
                                    }
                                </div>
                            </div>
                        `;
                    });
                    
                    adminListContainer.innerHTML = html || `
                        <div class="empty-state">
                            <i class="fas fa-user-shield"></i>
                            <p>暂无管理员信息</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('加载管理员列表失败:', error);
                    adminListContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>加载管理员列表失败: ${error.message}</p>
                        </div>
                    `;
                }
            },
            
            // 显示添加管理员模态框
            showAddAdminModal: function() {
                // 只有超级管理员才能添加管理员
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                // 创建添加管理员的模态框
                const modalHtml = `
                    <div id="admin-modal" class="modal" style="display: block;">
                        <div class="modal-content" style="width: 500px;">
                            <div class="modal-header">
                                <h2>添加管理员</h2>
                                <span class="close" onclick="systemSettingsManager.closeAdminModal()">&times;</span>
                            </div>
                            <div class="modal-body">
                                <form id="add-admin-form">
                                    <div class="form-group">
                                        <label for="admin-username">用户名</label>
                                        <input type="text" id="admin-username" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="admin-password">密码</label>
                                        <input type="password" id="admin-password" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="admin-role">角色</label>
                                        <select id="admin-role" class="form-control">
                                            <option value="admin">管理员</option>
                                            <option value="operator">操作员</option>
                                            <option value="viewer">查看者</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-primary">添加管理员</button>
                                        <button type="button" class="btn btn-secondary" onclick="systemSettingsManager.closeAdminModal()">取消</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加模态框到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 绑定表单提交事件
                document.getElementById('add-admin-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addAdmin();
                });
            },
            
            // 添加管理员
            addAdmin: async function() {
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                const role = document.getElementById('admin-role').value;
                
                // 简单验证
                if (!username || !password) {
                    utils.showNotification('用户名和密码不能为空', 'error');
                    return;
                }
                
                try {
                    // 发送添加管理员请求到服务器
                    const response = await fetch(this.apiEndpoints.admins, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ username, password, role })
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '添加管理员失败');
                    }
                    
                    const result = await response.json();
                    
                    utils.showNotification(`管理员 ${username} 已添加，角色: ${role}`, 'success');
                    this.closeAdminModal();
                    this.loadAdminList(); // 重新加载管理员列表
                } catch (error) {
                    utils.showNotification(`添加管理员失败: ${error.message}`, 'error');
                }
            },
            
            // 显示编辑管理员模态框
            showEditAdminModal: async function(adminId) {
                // 只有超级管理员才能编辑管理员
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                try {
                    // 获取管理员详细信息
                    const response = await fetch(`${this.apiEndpoints.admins}/${adminId}`, {
                        headers: {
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '获取管理员信息失败');
                    }
                    
                    const result = await response.json();
                    const admin = result.data;
                    
                    // 创建编辑管理员的模态框
                    const modalHtml = `
                        <div id="admin-modal" class="modal" style="display: block;">
                            <div class="modal-content" style="width: 500px;">
                                <div class="modal-header">
                                    <h2>编辑管理员</h2>
                                    <span class="close" onclick="systemSettingsManager.closeAdminModal()">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <form id="edit-admin-form">
                                        <input type="hidden" id="edit-admin-id" value="${admin.id}">
                                        <div class="form-group">
                                            <label for="edit-admin-username">用户名</label>
                                            <input type="text" id="edit-admin-username" class="form-control" value="${admin.username}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-admin-password">新密码 (留空则不修改)</label>
                                            <input type="password" id="edit-admin-password" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-admin-role">角色</label>
                                            <select id="edit-admin-role" class="form-control">
                                                <option value="admin" ${admin.role === 'admin' ? 'selected' : ''}>管理员</option>
                                                <option value="operator" ${admin.role === 'operator' ? 'selected' : ''}>操作员</option>
                                                <option value="viewer" ${admin.role === 'viewer' ? 'selected' : ''}>查看者</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-primary">保存更改</button>
                                            <button type="button" class="btn btn-secondary" onclick="systemSettingsManager.closeAdminModal()">取消</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 添加模态框到页面
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // 绑定表单提交事件
                    document.getElementById('edit-admin-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.updateAdmin();
                    });
                } catch (error) {
                    utils.showNotification(`获取管理员信息失败: ${error.message}`, 'error');
                }
            },
            
            // 更新管理员信息
            updateAdmin: async function() {
                const id = document.getElementById('edit-admin-id').value;
                const username = document.getElementById('edit-admin-username').value;
                const password = document.getElementById('edit-admin-password').value;
                const role = document.getElementById('edit-admin-role').value;
                
                // 简单验证
                if (!username) {
                    utils.showNotification('用户名不能为空', 'error');
                    return;
                }
                
                try {
                    // 准备更新数据
                    const updateData = { username, role };
                    if (password) {
                        updateData.password = password;
                    }
                    
                    // 发送更新请求到服务器
                    const response = await fetch(`${this.apiEndpoints.admins}/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '更新管理员信息失败');
                    }
                    
                    const result = await response.json();
                    
                    utils.showNotification(`管理员 ${username} 信息已更新`, 'success');
                    this.closeAdminModal();
                    this.loadAdminList(); // 重新加载管理员列表
                } catch (error) {
                    utils.showNotification(`更新管理员失败: ${error.message}`, 'error');
                }
            },
            
            // 关闭管理员模态框
            closeAdminModal: function() {
                const modal = document.getElementById('admin-modal');
                if (modal) {
                    modal.remove();
                }
            },
            
            // 搜索管理员
            searchAdmins: async function() {
                if (!permissionManager.hasRole('admin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                const searchTerm = document.getElementById('admin-search').value;
                
                try {
                    const adminListContainer = document.getElementById('admin-list');
                    if (!adminListContainer) return;
                    
                    // 显示加载状态
                    adminListContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>搜索中...</p>
                        </div>
                    `;
                    
                    // 发送搜索请求到服务器
                    const response = await fetch(`${this.apiEndpoints.admins}?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '搜索管理员失败');
                    }
                    
                    const result = await response.json();
                    const admins = result.data || [];
                    
                    let html = '';
                    admins.forEach(admin => {
                        html += `
                            <div class="device-item">
                                <div class="device-info">
                                    <h3>${admin.username}</h3>
                                    <p>角色: ${admin.role}</p>
                                    <p>最后登录: ${admin.lastLogin || 'N/A'}</p>
                                </div>
                                <div class="device-actions">
                                    ${
                                        permissionManager.hasRole('superadmin') && admin.username !== 'admin' 
                                        ? `<button class="btn btn-sm btn-warning" onclick="systemSettingsManager.editAdmin(${admin.id})">编辑</button>
                                           <button class="btn btn-sm btn-danger" onclick="systemSettingsManager.deleteAdmin(${admin.id})">删除</button>`
                                        : admin.username === 'admin' 
                                        ? '<span class="status-badge status-active">系统账户</span>'
                                        : '<span class="status-badge status-inactive">只读</span>'
                                    }
                                </div>
                            </div>
                        `;
                    });
                    
                    adminListContainer.innerHTML = html || `
                        <div class="empty-state">
                            <i class="fas fa-user-shield"></i>
                            <p>未找到匹配的管理员</p>
                        </div>
                    `;
                } catch (error) {
                    utils.showNotification(`搜索管理员失败: ${error.message}`, 'error');
                }
            },
            
            // 加载角色权限
            loadRolePermissions: async function(role) {
                if (!permissionManager.hasRole('admin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                try {
                    // 从服务器获取角色权限信息
                    const response = await fetch(`${this.apiEndpoints.roles}/${role}/permissions`, {
                        headers: {
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '加载角色权限失败');
                    }
                    
                    const result = await response.json();
                    const permissions = result.data || [];
                    
                    const checkboxes = document.querySelectorAll('.preference-item input[type="checkbox"]');
                    checkboxes.forEach((checkbox, index) => {
                        // 根据权限设置复选框状态
                        checkbox.checked = permissions[index] || false;
                        
                        // 只有超级管理员可以修改权限
                        if (!permissionManager.hasRole('superadmin')) {
                            checkbox.disabled = true;
                        }
                    });
                } catch (error) {
                    utils.showNotification(`加载角色权限失败: ${error.message}`, 'error');
                }
            },
            
            // 保存角色权限
            saveRolePermissions: async function() {
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                const role = document.getElementById('role-selector').value;
                if (!role) {
                    utils.showNotification('请选择一个角色', 'error');
                    return;
                }
                
                try {
                    // 收集权限设置
                    const checkboxes = document.querySelectorAll('.preference-item input[type="checkbox"]');
                    const permissions = Array.from(checkboxes).map(checkbox => checkbox.checked);
                    
                    // 发送保存权限请求到服务器
                    const response = await fetch(`${this.apiEndpoints.roles}/${role}/permissions`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ permissions })
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '保存权限配置失败');
                    }
                    
                    utils.showNotification('权限配置已保存', 'success');
                } catch (error) {
                    utils.showNotification(`保存权限配置失败: ${error.message}`, 'error');
                }
            },

            // 备份数据库
            backupDatabase: async function() {
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                try {
                    utils.showNotification('正在备份数据库...', 'info');
                    
                    // 发送备份请求到服务器
                    const response = await fetch('/api/system/backup', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '备份数据库失败');
                    }
                    
                    utils.showNotification('数据库备份完成', 'success');
                } catch (error) {
                    utils.showNotification(`备份数据库失败: ${error.message}`, 'error');
                }
            },
            
            // 重启服务
            restartService: function() {
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                utils.confirmAction('确定要重启服务吗？这可能会导致短暂的服务中断。')
                    .then(async result => {
                        if (result) {
                            try {
                                utils.showNotification('正在重启服务...', 'info');
                                
                                // 发送重启请求到服务器
                                const response = await fetch('/api/system/restart', {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                                    }
                                });
                                
                                if (!response.ok) {
                                    const errorResult = await response.json();
                                    throw new Error(errorResult.error || '重启服务失败');
                                }
                                
                                utils.showNotification('服务重启完成', 'success');
                            } catch (error) {
                                utils.showNotification(`重启服务失败: ${error.message}`, 'error');
                            }
                        }
                    });
            },
            
            // 切换维护模式
            toggleMaintenanceMode: async function(enabled) {
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    // 恢复开关状态
                    const maintenanceMode = document.getElementById('maintenance-mode');
                    if (maintenanceMode) {
                        maintenanceMode.checked = !enabled;
                    }
                    return;
                }
                
                try {
                    // 发送切换维护模式请求到服务器
                    const response = await fetch('/api/system/maintenance', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ maintenance: enabled })
                    });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || '切换维护模式失败');
                    }
                    
                    utils.showNotification(`维护模式已${enabled ? '开启' : '关闭'}`, 'success');
                } catch (error) {
                    utils.showNotification(`切换维护模式失败: ${error.message}`, 'error');
                    // 恢复开关状态
                    const maintenanceMode = document.getElementById('maintenance-mode');
                    if (maintenanceMode) {
                        maintenanceMode.checked = !enabled;
                    }
                }
            },
            
            // 编辑管理员
            editAdmin: function(adminId) {
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                this.showEditAdminModal(adminId);
            },
            
            // 删除管理员
            deleteAdmin: function(adminId) {
                if (!permissionManager.hasRole('superadmin')) {
                    utils.showNotification('您没有权限执行此操作', 'error');
                    return;
                }
                
                // 不能删除自己
                const currentUsername = authService.getCurrentUsername();
                const admins = [
                    { id: 1, username: 'admin' },
                    { id: 2, username: 'administrator' },
                    { id: 3, username: 'operator1' }
                ];
                
                const admin = admins.find(a => a.id === adminId);
                if (admin && admin.username === currentUsername) {
                    utils.showNotification('不能删除当前登录的管理员账户', 'error');
                    return;
                }
                
                utils.confirmAction('确定要删除此管理员吗？')
                    .then(async result => {
                        if (result) {
                            try {
                                // 发送删除请求到服务器
                                const response = await fetch(`${this.apiEndpoints.admins}/${adminId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${sessionStorage.getItem('token') || localStorage.getItem('token')}`
                                    }
                                });
                                
                                if (!response.ok) {
                                    const errorResult = await response.json();
                                    throw new Error(errorResult.error || '删除管理员失败');
                                }
                                
                                utils.showNotification('管理员已删除', 'success');
                                // 重新加载管理员列表
                                this.loadAdminList();
                            } catch (error) {
                                utils.showNotification(`删除管理员失败: ${error.message}`, 'error');
                            }
                        }
                    });
            }
        };

        // 认证服务
        const authService = {
            // 检查是否已认证
            isAuthenticated: function() {
                return localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true';
            },
            
            // 登录
            login: async function(credentials) {
                try {
                    // 首先检查是否为预定义的测试账户
                    const testAccounts = {
                        'admin': { password: 'admin123', role: 'superadmin' },
                        'administrator': { password: 'password', role: 'admin' },
                        'user': { password: 'pass', role: 'viewer' }
                    };
                    
                    // 如果是测试账户，直接验证
                    if (testAccounts[credentials.username] && 
                        credentials.password === testAccounts[credentials.username].password) {
                        
                        const userData = {
                            token: 'test-token-' + Date.now(),
                            username: credentials.username,
                            role: testAccounts[credentials.username].role
                        };
                        
                        // 保存认证信息到 sessionStorage（会话级别）
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('token', userData.token);
                        sessionStorage.setItem('username', userData.username);
                        sessionStorage.setItem('adminRole', userData.role);
                        
                        // 如果用户选择记住我，则保存到 localStorage
                        const rememberMeCheckbox = document.getElementById('remember-me');
                        if (rememberMeCheckbox && rememberMeCheckbox.checked) {
                            localStorage.setItem('isLoggedIn', 'true');
                            localStorage.setItem('token', userData.token);
                            localStorage.setItem('username', userData.username);
                            localStorage.setItem('adminRole', userData.role);
                            localStorage.setItem('rememberMe', 'true');
                        } else {
                            localStorage.removeItem('rememberMe');
                        }
                        
                        return { 
                            success: true,
                            token: userData.token,
                            username: userData.username,
                            role: userData.role
                        };
                    }
                    
                    // 如果不是测试账户，尝试通过服务器验证
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(credentials)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            return { success: false, error: '用户名或密码错误' };
                        } else {
                            return { success: false, error: '登录失败，请稍后重试' };
                        }
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 保存认证信息到 sessionStorage（会话级别）
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('token', result.token);
                        sessionStorage.setItem('username', result.username);
                        sessionStorage.setItem('adminRole', result.role || 'admin');
                        
                        // 如果用户选择记住我，则保存到 localStorage
                        const rememberMeCheckbox = document.getElementById('remember-me');
                        if (rememberMeCheckbox && rememberMeCheckbox.checked) {
                            localStorage.setItem('isLoggedIn', 'true');
                            localStorage.setItem('token', result.token);
                            localStorage.setItem('username', result.username);
                            localStorage.setItem('adminRole', result.role || 'admin');
                            localStorage.setItem('rememberMe', 'true');
                        } else {
                            localStorage.removeItem('rememberMe');
                        }
                        
                        return { 
                            success: true,
                            token: result.token,
                            username: result.username,
                            role: result.role || 'admin'
                        };
                    } else {
                        return { success: false, error: result.error || '登录失败' };
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    return { success: false, error: '网络错误，请检查您的连接' };
                }
            },
            
            // 登出
            logout: function() {
                // 清除 sessionStorage
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('token');
                sessionStorage.removeItem('username');
                sessionStorage.removeItem('adminRole');
                
                // 清除 localStorage 中的认证信息（但保留记住我选项）
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                localStorage.removeItem('adminRole');
            },
            
            // 获取当前用户角色
            getCurrentUserRole: function() {
                return sessionStorage.getItem('adminRole') || localStorage.getItem('adminRole') || 'viewer';
            },
            
            // 检查是否记住登录状态
            isRememberMe: function() {
                return localStorage.getItem('rememberMe') === 'true';
            },
            
            // 获取当前用户名
            getCurrentUsername: function() {
                return sessionStorage.getItem('username') || localStorage.getItem('username') || '';
            }
        };
        
        // 权限管理模块
        const permissionManager = {
            // 定义角色权限
            roles: {
                'superadmin': ['read', 'write', 'delete', 'manage_admins'],
                'admin': ['read', 'write', 'delete'],
                'viewer': ['read']
            },
            
            // 检查用户是否有特定权限
            hasPermission: function(permission) {
                const role = authService.getCurrentUserRole();
                const permissions = this.roles[role] || [];
                return permissions.includes(permission);
            },
            
            // 检查用户是否有特定角色或更高权限
            hasRole: function(requiredRole) {
                const currentRole = authService.getCurrentUserRole();
                const roleHierarchy = {
                    'viewer': 1,
                    'admin': 2,
                    'superadmin': 3
                };
                
                return (roleHierarchy[currentRole] || 0) >= (roleHierarchy[requiredRole] || 0);
            },
            
            // 显示或隐藏受限内容
            updateContentVisibility: function() {
                const isAuthenticated = authService.isAuthenticated();
                const userRole = authService.getCurrentUserRole();
                
                // 更新所有受限内容的显示状态
                document.querySelectorAll('.restricted-content').forEach(element => {
                    if (element.id && element.id.endsWith('-content')) {
                        // 内容区域
                        if (isAuthenticated) {
                            element.style.display = 'block';
                        } else {
                            element.style.display = 'none';
                        }
                    } else if (element.id && element.id.endsWith('-restricted')) {
                        // 受限提示区域
                        if (isAuthenticated) {
                            element.style.display = 'none';
                        } else {
                            element.style.display = 'block';
                        }
                    }
                });
                
                // 根据角色显示/隐藏特定功能
                document.querySelectorAll('[data-required-role]').forEach(element => {
                    const requiredRole = element.getAttribute('data-required-role');
                    element.style.display = this.hasRole(requiredRole) ? 'block' : 'none';
                });
                
                // 根据权限显示/隐藏特定操作
                document.querySelectorAll('[data-required-permission]').forEach(element => {
                    const requiredPermission = element.getAttribute('data-required-permission');
                    element.style.display = this.hasPermission(requiredPermission) ? '' : 'none';
                });
                
                // 特殊处理仪表盘欢迎内容
                const dashboardContent = document.getElementById('dashboard');
                if (dashboardContent) {
                    const welcomeContent = dashboardContent.querySelector('#welcome-content');
                    if (welcomeContent) {
                        if (isAuthenticated) {
                            const username = authService.getCurrentUsername();
                            const roleDisplayNames = {
                                'superadmin': '超级管理员',
                                'admin': '管理员',
                                'viewer': '查看者'
                            };
                            const roleDisplayName = roleDisplayNames[userRole] || userRole;
                            
                            welcomeContent.innerHTML = `
                                <p>欢迎回来，<strong>${username}</strong>！</p>
                                <p>您已成功登录系统，当前角色：<strong>${roleDisplayName}</strong>，可以访问相应权限的功能。</p>
                            `;
                        } else {
                            welcomeContent.innerHTML = '<p>请登录以访问所有功能。</p>';
                        }
                    }
                }
            }
        };

        // 登录表单提交处理
        async function handleLogin(e) {
            e.preventDefault();
            
            console.log('登录表单提交');
            
            const usernameInput = document.getElementById('login-username');
            const passwordInput = document.getElementById('login-password');
            
            if (!usernameInput || !passwordInput) {
                utils.showNotification('登录表单元素缺失', 'error');
                return;
            }
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            console.log('用户名:', username, '密码:', password);
            
            if (!username || !password) {
                utils.showNotification('请输入用户名和密码', 'warning');
                return;
            }
            
            const loginSubmitBtn = document.getElementById('login-submit-btn');
            const loginSubmitText = document.getElementById('login-submit-text');
            const loginSubmitLoader = document.getElementById('login-submit-loader');
            
            // 设置按钮为加载状态
            if (loginSubmitBtn && loginSubmitText && loginSubmitLoader) {
                utils.setButtonLoading(loginSubmitBtn, loginSubmitText, loginSubmitLoader, true);
            }
            
            try {
                const result = await authService.login({ username, password });
                console.log('登录结果:', result);
                
                if (result.success) {
                    utils.showNotification('登录成功', 'success');
                    
                    // 更新UI状态
                    document.getElementById('login-info').style.display = 'none';
                    document.getElementById('user-profile').style.display = 'flex';
                    document.getElementById('username').textContent = result.username || username;
                    
                    // 关闭模态框
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        loginModal.classList.remove('show');
                    }
                    
                    // 更新内容可见性
                    permissionManager.updateContentVisibility();
                } else {
                    // 登录失败，显示错误信息
                    utils.showNotification(result.error || '登录失败', 'error');
                }
            } catch (error) {
                utils.showNotification('登录请求失败: ' + error.message, 'error');
                console.error('Login error:', error);
            } finally {
                // 恢复按钮状态
                if (loginSubmitBtn && loginSubmitText && loginSubmitLoader) {
                    utils.setButtonLoading(loginSubmitBtn, loginSubmitText, loginSubmitLoader, false);
                }
            }
        
// ... existing code ...
            
            // 绑定登录表单提交事件
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // 绑定登录表单回车事件
            const loginInputs = document.querySelectorAll('#login-form input');
            if (loginInputs) {
                loginInputs.forEach(input => {
                    input.addEventListener('keyup', function (event) {
                        if (event.keyCode === 13) {
                            handleLogin(event);
                        }
                    });
                });
            }
            function handleLogin(event) { 
            }
            function handleLogout(event) { 
            }
        }   
      
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有模块
            try {
                // 初始化认证管理
                if (typeof authManager !== 'undefined' && typeof authManager.init === 'function') {
                    authManager.init();
                }
                
                // 初始化仪表盘
                if (typeof dashboard !== 'undefined' && typeof dashboard.init === 'function') {
                    dashboard.init();
                }
                
                // 初始化API配置管理
                if (typeof apiConfigManager !== 'undefined' && typeof apiConfigManager.init === 'function') {
                    apiConfigManager.init();
                }
                
                // 初始化用户画像管理
                if (typeof userProfileManager !== 'undefined' && typeof userProfileManager.init === 'function') {
                    userProfileManager.init();
                }
                
                // 初始化生物识别管理
                if (typeof biometricManager !== 'undefined' && typeof biometricManager.init === 'function') {
                    biometricManager.init();
                }
                
                // 初始化偏好设置管理
                if (typeof preferenceManager !== 'undefined' && typeof preferenceManager.init === 'function') {
                    preferenceManager.init();
                }
                
                // 初始化设备管理
                if (typeof deviceManager !== 'undefined' && typeof deviceManager.init === 'function') {
                    deviceManager.init();
                }
                
                // 初始化用户管理
                if (typeof userManager !== 'undefined' && typeof userManager.init === 'function') {
                    userManager.init();
                }
                
                // 初始化管理员管理
                if (typeof adminManager !== 'undefined' && typeof adminManager.init === 'function') {
                    adminManager.init();
                }
                
                // 初始化用户管理（重复的模块）
                if (typeof userManagement !== 'undefined' && typeof userManagement.init === 'function') {
                    userManagement.init();
                }
            } catch (error) {
                console.error('初始化模块时出错:', error);
            }
       
            // 初始化仪表盘
            dashboardManager.loadDashboardStats();
            setInterval(() => dashboardManager.updateCurrentTime(), 1000);
            dashboardManager.updateCurrentTime();
            
            // 初始化API配置管理
            apiConfigManager.init();
            
            // 绑定用户画像搜索事件
            document.getElementById('search-user-btn').addEventListener('click', function(e) {
                e.preventDefault();
                userManager.searchUser();
            });
            
            // 绑定用户信息表单提交事件
            document.getElementById('user-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                userManager.saveUserInfo();
            });
            
            // 绑定生物识别加载事件
            document.getElementById('load-biometric-btn').addEventListener('click', function(e) {
                e.preventDefault();
                biometricManager.loadBiometricInfo();
            });
            
            // 绑定用户偏好设置加载事件
            document.getElementById('load-preferences').addEventListener('click', function(e) {
                e.preventDefault();
                preferenceManager.loadUserPreferences();
            });
            
            // 绑定登录表单提交事件
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                const loginBtn = document.getElementById('login-submit-btn');
                const loginText = document.getElementById('login-submit-text');
                const loginLoader = document.getElementById('login-submit-loader');
                
                utils.setButtonLoading(loginBtn, loginText, loginLoader, true);
                
                try {
                    const result = await authService.login({ username, password });
                    
                    if (result.success) {
                        utils.showNotification('登录成功', 'success');
                        
                        // 更新UI
                        document.getElementById('login-info').style.display = 'none';
                        document.getElementById('user-profile').style.display = 'flex';
                        document.getElementById('username').textContent = result.username || username;
                        
                        // 关闭模态框
                        document.getElementById('login-modal').classList.remove('show');
                        
                        // 显示受限内容
                        document.querySelectorAll('.restricted-content').forEach(el => {
                            if (el.id.endsWith('-restricted')) {
                                el.style.display = 'none';
                            } else if (el.id.endsWith('-content')) {
                                el.style.display = 'block';
                            }
                        });
                        
                        // 更新内容可见性（包括权限相关）
                        permissionManager.updateContentVisibility();
                        
                        // 初始化系统设置（在登录成功后）
                        if (permissionManager.hasRole('admin')) {
                            systemSettingsManager.init();
                        }
                    } else {
                        // 登录失败，显示错误信息
                        utils.showNotification(result.error || '登录失败', 'error');
                    }
                } catch (error) {
                    utils.showNotification('登录失败: ' + error.message, 'error');
                } finally {
                    utils.setButtonLoading(loginBtn, loginText, loginLoader, false);
                }
            });
            
            // 绑定登出事件
            document.getElementById('logout-btn').addEventListener('click', function() {
                authService.logout();
                utils.showNotification('已成功登出', 'success');
                
                // 隐藏受限内容
                document.querySelectorAll('.restricted-content').forEach(el => {
                    if (el.id.endsWith('-restricted')) {
                        el.style.display = 'block';
                    } else if (el.id.endsWith('-content')) {
                        el.style.display = 'none';
                    }
                });
            });
            
            // 绑定登录按钮事件
            document.getElementById('login-btn').addEventListener('click', function() {
                document.getElementById('login-modal').classList.add('show');
                // 恢复记住我状态
                document.getElementById('remember-me').checked = authService.isRememberMe();
            });
            
            // 绑定关闭模态框事件
            document.getElementById('close-login-modal').addEventListener('click', function() {
                document.getElementById('login-modal').classList.remove('show');
            });
            
            // 点击模态框外部关闭
            document.getElementById('login-modal').addEventListener('click', function(e) {
                if (e.target.id === 'login-modal') {
                    this.classList.remove('show');
                }
            });
            
            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.getElementById('login-modal').classList.remove('show');
                }
            });
            
            // 在标签切换代码中添加API配置管理初始化
            // 标签切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    
                    // 更新标签激活状态
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 显示对应内容
                    document.querySelectorAll('.content').forEach(content => {
                        content.classList.remove('active');
                        if (content.id === target) {
                            content.classList.add('active');
                            
                            // 当切换到API配置标签时，初始化API配置管理器
                            if (target === 'api-config' && authService.isAuthenticated()) {
                                // 延迟初始化以确保DOM已完全加载
                                setTimeout(() => {
                                    apiConfigManager.init();
                                }, 100);
                            }
                            
                            // 当切换到系统设置标签时，初始化系统设置管理器
                            if (target === 'system-settings' && authService.isAuthenticated()) {
                                // 延迟初始化以确保DOM已完全加载
                                setTimeout(() => {
                                    systemSettingsManager.init();
                                }, 100);
                            }
                        }
                    });
                });
            });
            
            // 为所有"立即登录"按钮绑定事件
            document.querySelectorAll('[class$="-login-btn"]').forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById('login-modal').classList.add('show');
                });
            });
       
            // 初始化所有模块
            authManager.init();
            dashboard.init();
            apiConfigManager.init();
            userProfileManager.init();
            biometricManager.init();
            preferenceManager.init();
            deviceManager.init();
            userManager.init();
            adminManager.init();
            userManagement.init(); // 添加这一行来初始化用户管理模块
        
        });

    </script>
</body>
</html>