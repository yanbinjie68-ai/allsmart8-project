# 安全开发规范

本文档旨在为外部开发者提供安全开发指导，防止敏感信息泄露和安全漏洞。

## 1. 敏感信息处理

### 1.1 环境变量
- 所有敏感信息（如API密钥、密码、密钥等）必须通过环境变量传递
- 禁止在代码中硬编码敏感信息
- 使用 `.env.example` 作为模板，而不是直接使用 `.env`

```python
# 正确做法
import os
API_KEY = os.getenv('API_KEY')

# 错误做法
API_KEY = 'sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
```

### 1.2 配置文件
- 敏感配置文件（如 `.env`）必须加入 `.gitignore`
- 只提供示例配置文件（如 `.env.example`）
- 配置文件中使用占位符而非真实值

### 1.3 数据库安全
- 开发环境中使用测试数据库
- 不在代码库中包含真实数据
- 敏感字段（如API密钥）在数据库中加密存储

## 2. 代码审查要点

### 2.1 提交前检查
- 确保没有敏感信息被提交到版本控制系统
- 使用 `.gitignore` 排除敏感文件
- 检查提交内容中是否包含密钥、密码等

### 2.2 代码规范
- 遵循最小权限原则
- 对输入进行验证和过滤
- 避免SQL注入、XSS等安全漏洞
- 使用参数化查询处理数据库操作

## 3. API密钥管理

### 3.1 加密存储
项目使用 `secure_keys.py` 模块对敏感信息进行加密存储：

```python
from secure_keys import secure_key_manager

# 加密API密钥
encrypted_key = secure_key_manager.encrypt_key("your-api-key")

# 解密API密钥
decrypted_key = secure_key_manager.decrypt_key(encrypted_key)
```

### 3.2 密钥轮换
- 定期更换API密钥
- 在环境变量中更新密钥
- 通过管理界面更新数据库中的加密密钥

## 4. 访问控制

### 4.1 用户权限
项目实现了基于角色的访问控制（RBAC）：
- user: 普通用户权限
- admin: 管理员权限
- superadmin: 超级管理员权限

```python
from auth import check_role

@app.get("/admin-only")
def admin_endpoint(current_user = Depends(check_role("admin"))):
    return {"message": "仅管理员可访问"}
```

### 4.2 JWT令牌安全
- 使用强密钥签名JWT令牌
- 设置合适的过期时间
- 验证令牌时检查权限

## 5. 数据保护

### 5.1 数据传输
- 使用HTTPS加密传输数据
- 敏感API端点需要认证
- 限制API请求频率

### 5.2 数据存储
- 密码使用bcrypt哈希存储
- 敏感信息在数据库中加密
- 定期备份数据库

## 6. 日志和监控

### 6.1 日志记录
- 不在日志中记录敏感信息
- 记录安全相关事件
- 定期审查日志

### 6.2 错误处理
- 不向客户端暴露敏感错误信息
- 统一错误处理机制
- 记录异常但不泄露细节

## 7. 外发开发流程

### 7.1 环境准备
1. 使用 `prepare_for_external_dev.py` 脚本清理敏感信息
2. 创建独立的开发分支
3. 提供安全的开发环境说明

### 7.2 开发规范
1. 提供详细的开发文档
2. 明确安全开发要求
3. 定期进行代码审查

### 7.3 交付检查
1. 确保没有敏感信息泄露
2. 验证功能完整性和安全性
3. 更新相关文档

## 8. 应急响应

### 8.1 安全事件处理
- 发现安全漏洞立即报告
- 及时修复和更新
- 通知相关用户和开发者

### 8.2 密钥泄露处理
- 立即撤销泄露的密钥
- 生成新的密钥
- 更新所有使用该密钥的地方

通过遵循以上安全规范，我们可以确保在外部开发过程中项目的安全性得到保障，避免敏感信息泄露。